---
title: "COVID19"
author: "Kimon"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)

dirpath <- 'D:/Documents/covid'
refresh <- FALSE
# refresh <- TRUE
```

```{r message=FALSE}
library(httr)
library(lubridate)
library(ggplot2)
library(broom)
library(patchwork)
library(data.table)
library(maps)
library(rgdal)
library(mapproj)
# library(gganimate)

options(scipen=2)
```

Pandemic data source: European Centre for Disease Control https://opendata.ecdc.europa.eu/covid19/

Detailed European maps: EUROSTAT NUTS2021
http://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statisticalunits

# Load current data

```{r download}
# Get latest data
###########

if (refresh){
  GET("https://opendata.ecdc.europa.eu/covid19/agecasesnational/csv", 
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'agecasesnational.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/agecasesubnational/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'agecasesubnational.csv'), overwrite = TRUE))
  # GET("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv",
  #     authenticate(":", ":", type="ntlm"),
  #     write_disk(file.path(dirpath,'casedistribution.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/hospitalicuadmissionrates/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'hospitalicuadmissionrates.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/movementindicators/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'movementindicators.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/nationalcasedeath/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'nationalcasedeath.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/subnationalcasedaily/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'subnationalcasedaily.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/subnationalcaseweekly/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'subnationalcaseweekly.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/testing/csv", 
      authenticate(":", ":", type="ntlm"), 
      write_disk(file.path(dirpath,'testing.csv'), overwrite = TRUE))
}
```

```{r load}
# Import data.
# Don't need the cruiseship.
agecasenat <- fread(encoding = 'UTF-8',
                    file.path(dirpath,'agecasesnational.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
agecasesubnat <- fread(encoding = 'UTF-8',
                       file.path(dirpath,'agecasesubnational.csv')) # [country != 'Cases_on_an_international_conveyance_Japan',] # Still blank
# casedist <- fread(file.path(dirpath,'casedistribution.csv'))[countriesAndTerritories != 'Cases_on_an_international_conveyance_Japan', ]
hosprate <- fread(encoding = 'UTF-8',
                  file.path(dirpath,'hospitalicuadmissionrates.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
movement <- fread(encoding = 'UTF-8',
                  file.path(dirpath,'movementindicators.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
natcasedeath <- fread(encoding = 'UTF-8',
                      file.path(dirpath,'nationalcasedeath.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
subnatcaseday <- fread(encoding = 'UTF-8',
                       file.path(dirpath,'subnationalcasedaily.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
subnatcaseweek <- fread(encoding = 'UTF-8',
                        file.path(dirpath,'subnationalcaseweekly.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
testing <- fread(encoding = 'UTF-8', 
                 file.path(dirpath,'testing.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]

# Verify that the data format wasn't changed again
stopifnot(names(agecasenat) == c('country', 'country_code', 'year_week', 'age_group', 'new_cases', 'population', 'rate_14_day_per_100k', 'source'))
stopifnot(names(agecasesubnat) == c('Test'))
# stopifnot(names(casedist) == c('dateRep', 'day', 'month', 'year', 'cases', 'deaths', 'countriesAndTerritories', 'geoId', 'countryterritoryCode', 'popData2019', 'continentExp', 'Cumulative_number_for_14_days_of_COVID-19_cases_per_100000'))
stopifnot(names(hosprate) == c('country', 'indicator', 'date', 'year_week', 'value', 'source', 'url'))
stopifnot(names(movement) == c('col0', 'country', 'country_code', 'geo_id_final', 'region', 'subnational_cases_7', 'subnational_cases_14', 'subnational_population', 'subnational_rate_14', 'national_cases_7', 'national_population', 'national_testing_rate', 'national_positivity_rate', 'subnational_testing_data', 'positivity_rate_combined', 'testing_rate_combined', 'colour', 'week'))
stopifnot(names(natcasedeath) == c('country', 'country_code', 'continent', 'population', 'indicator', 'weekly_count', 'year_week', 'rate_14_day', 'cumulative_count', 'source'))
stopifnot(names(subnatcaseday) == c('country', 'region_name', 'nuts_code', 'date', 'rate_14_day_per_100k', 'source'))
stopifnot(names(subnatcaseweek) == c('country', 'region_name', 'nuts_code', 'year_week', 'rate_14_day_per_100k', 'source'))
stopifnot(names(testing) == c('country', 'country_code', 'year_week', 'level', 'region', 'region_name', 'new_cases', 'tests_done', 'population', 'testing_rate', 'positivity_rate', 'testing_data_source'))


# Make dates workable and uniform
#################################

# str(agecasenat)
##str(agecasesubnat)
# str(casedist)
# casedist[, dateRep := dmy(dateRep)]
# str(hosprate)
hosprate[, date := as.Date(date)]
hosprate[, year_week := sub('W', '', year_week)]
# str(movement)
# str(natcasedeath)
# str(subnatcaseday)
subnatcaseday[, date := as.Date(date)]
# str(subnatcaseweek)
subnatcaseweek[, year_week := sub('W', '', year_week)]
# str(testing)
testing[, year_week := sub('W', '', year_week)]
```

```{r loadmaps}
# Map outlines
##############

# Simple world map
world_map <- as.data.table(map_data('world'))

# Finer-detailed EU map.
# Covid data for the countries is recorded at different NUTS levels, so I'm using all the levels and let the merge sort out what's appropriate in each case.
eut <- readOGR(file.path(dirpath, 'ref-nuts-2021-01m.shp', 'NUTS_RG_01M_2021_4326.shp'))
eut@data['id'] <- as.character(seq.int(0, nrow(eut@data)-1))
eutt <- as.data.table(tidy(eut))
eut <- merge(eutt, eut@data, by='id')


# Sanitize countries
world_map[grepl('Antigua|Barbuda', region, perl=TRUE), region := 'Antigua and Barbuda']
natcasedeath[grepl('Antigua|Barbuda', country, perl=TRUE), country := 'Antigua and Barbuda']
world_map[region=='Bonaire', region := 'Bonaire, Saint Eustatius and Saba']
world_map[region=='Sint_Eustatius', region := 'Bonaire, Saint Eustatius and Saba']
world_map[region=='Saba', region := 'Bonaire, Saint Eustatius and Saba']
natcasedeath[grepl('Virgin', country, fixed=TRUE), country := 'Virgin Islands']
natcasedeath[country=='Virgin Islands', weekly_count := sum(weekly_count), by=c('year_week', 'indicator')]
natcasedeath[country=='Virgin Islands', cumulative_count := sum(cumulative_count), by=c('year_week', 'indicator')]
natcasedeath[country=='Virgin Islands', rate_14_day := mean(rate_14_day), by=c('year_week', 'indicator')]
natcasedeath[country=='Virgin Islands', population := sum(population), by=c('year_week', 'indicator')]
natcasedeath[country=='Virgin Islands', country_code := 'VIR']
natcasedeath <- unique(natcasedeath)
world_map[region=='Cape Verde', region := 'Cabo Verde']
world_map[region=='Republic of Congo', region := 'Congo']
world_map[region=='Curacao', region := 'Curaçao']
world_map[region=='Czech Republic', region := 'Czechia']
world_map[region=='Swaziland', region := 'Eswatini']
world_map[region=='Ivory Coast', region := 'Côte d’Ivoire']
world_map[region=='Faroe Islands', region := 'Faroes']
natcasedeath[grepl('Myanmar', country, fixed=TRUE), country := 'Myanmar']
world_map[region=='Macedonia', region := 'North Macedonia']
world_map[region=='Nevis', region := 'Saint Kitts and Nevis']
world_map[region=='Saint Kitts', region := 'Saint Kitts and Nevis']
world_map[region=='Grenadines', region := 'Saint Vincent and the Grenadines']
world_map[region=='Saint Vincent', region := 'Saint Vincent and the Grenadines']
world_map[region=='Sao Tome and Principe', region := 'São Tomé and Príncipe']
natcasedeath[grepl('Gambia', country, fixed=TRUE), country := 'Gambia']
natcasedeath[grepl('Vatican', country, fixed=TRUE), country := 'Vatican']
world_map[region=='Trinidad', region := 'Trinidad and Tobago']
world_map[region=='Tobago', region := 'Trinidad and Tobago']
world_map[region=='UK', region := 'United Kingdom']
natcasedeath[country=='United States', country := 'USA']

# Countries that still don't match
print( data.frame(Only_in_the_data = setdiff(
  unique(natcasedeath$country), 
  unique(world_map$region)) ) )
print( data.frame(Only_in_the_map = setdiff(
  unique(world_map$region), 
  unique(natcasedeath$country)) ) )

# Overseas territories of France, Spain and Portugal force too much zoom-out. 
# Remove them to focus on the continent.
# eut <- eut[! NUTS_ID %in% c('ES70', 'FRY1', 'FRY2', 'FRY3', 'FRY4', 'FRY5', 'PT2', 'PT3'),]

# Add global coordinates to the data tables
####################################

# Merge on demand, to save on table size instead.
mapify <- function(dt, country1='country', country2='region') {
  merge(dt, world_map, by.x=country1, by.y=country2, all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE)
}
```

```{r settings}
# Countries to highlight
########################
homecountry = 'Austria'
# Selected countries
family_countries <- c('Austria', 'Italy', 'Greece', 'Luxembourg', 'Germany')
neighbour_countries <- c('Switzerland', 'Slovakia', 'Slovenia', 'Czechia', 'Hungary')
other_countries <- c('United Kingdom', 'Spain', 'France', 'Belgium', 'USA', 'Sweden')
holiday_options=c('Croatia', 'Greece', 'Italy', 'Malta', 'Spain', 'Turkey', 'Egypt')

# Colours
#########
seablue <- 'black'
case_col <- '#FF0000'
death_col <- '#0055FF'
hosp_col <- '#555500'
icu_col <- '#995500'
test_col <- '#005500'

# Normalization
popnorm= 1e5
natcasedeath[, population_normalized := weekly_count / population * popnorm]
```


# Status

```{r status}
setorder(natcasedeath, year_week, country)
setorder(subnatcaseday, date, country, nuts_code)

recentweeks <- tail(unique(natcasedeath$year_week), 3)

endweek <- max(natcasedeath$year_week)
startweek <- min(natcasedeath$year_week)
endday <- max(subnatcaseday$date)
startday <- min(subnatcaseday$date)

message(paste('First entries (week / day):', startweek, '/', startday))
message(paste('Last updates (week / day):', endweek, '/', endday))
# message(paste('Recording duration:', length(unique(casedist$year_week)), 'weeks'))
```

Based on the latest available date in the table. Some countries may be slower at releasing/entering their data, and not have current data to show.

## Maps

### Global

```{r global, fig.height=9, fig.width=22}
subDT <- merge(world_map[, .(region, long, lat, group, order)], 
               dcast(natcasedeath[year_week==endweek,], country + population ~ indicator, value.var = 'weekly_count'), 
               by.x='region', by.y='country', all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE)

p1 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases)) +
  geom_polygon(colour='transparent', size=0.01) +
  scale_fill_gradient(low='white', high=case_col, na.value='grey50', name='weekly cases') +
  coord_fixed(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  theme_void() +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank(),
        legend.position='left')

p3 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths)) +
  geom_polygon(colour='transparent', size=0.01) +
  scale_fill_gradient(low='white', high=death_col, na.value='grey50', name='weekly deaths') +
  coord_fixed(ylim=c(-60, 80), xlim=c(-180,180)) +  # Crop giant Antarctica and empty Arctic
  theme_void() +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank(),
        legend.position='right')



subDT <- merge(world_map[, .(region, long, lat, group, order)], 
               dcast(natcasedeath[year_week==endweek,], country + population ~ indicator, value.var = 'population_normalized'), 
               by.x='region', by.y='country', all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE)


p2 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases)) +
  geom_polygon(colour='transparent', size=0.01) +
  scale_fill_gradient(low='white', high=case_col, na.value='grey50', name=paste('weekly cases\nper', popnorm)) +
  coord_fixed(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  theme_void() +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank(),
        legend.position='left')


p4 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths)) +
  geom_polygon(colour='transparent', size=0.01) +
  coord_fixed(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=death_col, na.value='grey50', name=paste('weekly deaths\nper', popnorm)) +
  theme_void() +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank(),
        legend.position='right')
# 
# print( p3 / p4 )
# 
# ggsave(file.path(dirpath,'world_deaths.png'), plot = p3 / p4, device = png(),
#        scale = 1, width = 12, height = 12, units = "cm", dpi = 300, limitsize = TRUE)

print( (p1 | p3) / (p2 | p4) )

ggsave(file.path(dirpath,'world.png'), plot = ( (p1 | p3) / (p2 | p4) ), device = png(),
       scale = 1, width = 22, height = 9, units = "cm", dpi = 300, limitsize = TRUE)
```

### Europe

```{r europe, fig.height=9, fig.width=11}
subDT <- merge(world_map[, .(region, long, lat, group, order)], 
               dcast(natcasedeath[year_week==endweek & continent=='Europe',], country + population ~ indicator, value.var = 'weekly_count'), 
               by.x='region', by.y='country', all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE)

p1 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases)) +
  geom_polygon(colour='transparent', size=0.01) +
  scale_fill_gradient(low='white', high=case_col, na.value='transparent', name='weekly cases') +
  coord_map(projection='azequidistant',ylim=c(36, 68), xlim=c(-8,33)) +
  theme_void() +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='grey90'),
        legend.position='left')

p2 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases / population * popnorm)) +
  geom_polygon(colour='transparent', size=0.01) +
  scale_fill_gradient(low='white', high=case_col, na.value='transparent', name=paste('weekly cases\nper', popnorm)) +
  coord_map(projection='azequidistant',ylim=c(36, 68), xlim=c(-8,33)) +
  theme_void() +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='grey90'),
        legend.position='left')

# print( p1 / p2 )
# 
# ggsave(file.path(dirpath,'europe_cases.png'), plot = p1 / p2, device = png(), 
#        scale = 1, width = 10, height = 12, units = "cm", dpi = 300, limitsize = TRUE)

p3 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths)) +
  geom_polygon(colour='transparent', size=0.01) +
  scale_fill_gradient(low='white', high=death_col, na.value='transparent', name='weekly deaths') +
  coord_map(projection='azequidistant',ylim=c(36, 68), xlim=c(-8,33)) +
  theme_void() +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='grey90'),
        legend.position='right')

p4 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths / population * popnorm)) +
  geom_polygon(colour='transparent', size=0.01) +
  scale_fill_gradient(low='white', high=death_col, na.value='transparent', name=paste('weekly deaths\nper', popnorm)) +
  coord_map(projection='azequidistant',ylim=c(36, 68), xlim=c(-8,33)) +
  theme_void() +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='grey90'),
        legend.position='right')

# print( p3 / p4 )
# 
# ggsave(file.path(dirpath,'europe_deaths.png'), plot = p3 / p4, device = png(),
#        scale = 1, width = 10, height = 12, units = "cm", dpi = 300, limitsize = TRUE)

print( (p1 | p3) / (p2 | p4) )

ggsave(file.path(dirpath,'europe.png'), plot = ( (p1 | p3) / (p2 | p4) ), device = png(),
       scale = 1, width = 11, height = 9, units = "cm", dpi = 300, limitsize = TRUE)
```

### EU

```{r eu, fig.height=10, fig.width=11}
subDT <- merge(eut, 
               subnatcaseweek[year_week==endweek,],
               by.x='NUTS_ID', by.y='nuts_code', all.x=FALSE, all.y=FALSE)
setorder(subDT, LEVL_CODE, NUTS_ID, order)


p1 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=rate_14_day_per_100k)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient(low='white', high=case_col, name='per 100000') +
  coord_map(projection='azequidistant', xlim=c(-8, 33), ylim=c(36,70)) +
  labs(title='weekly wases') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))



subDT <- merge(eut, 
               subnatcaseweek[year_week %in% recentweeks[c(1,3)],],
               by.x='NUTS_ID', by.y='nuts_code', all.x=FALSE, all.y=FALSE)
subDT[, diff1 := rate_14_day_per_100k - shift(rate_14_day_per_100k, type='lag'), by=country]
subDT[, diff2 := rate_14_day_per_100k - shift(rate_14_day_per_100k, n=2, type='lag'), by=country]
setorder(subDT, LEVL_CODE, NUTS_ID, order)


p2 <- ggplot(subDT[year_week==endweek,],
       aes(x=long, y=lat, group=group,
           fill=diff1)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='forestgreen', mid='white', high='magenta', name='per 100000') +
  coord_map(projection='azequidistant', xlim=c(-8, 33), ylim=c(36,70)) +
  labs(title='weekly cases change', subtitle='compared to previous week') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))

p3 <- ggplot(subDT[year_week==endweek,],
       aes(x=long, y=lat, group=group,
           fill=diff2)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='forestgreen', mid='white', high='magenta', name='per 100000') +
  coord_map(projection='azequidistant', xlim=c(-8, 33), ylim=c(36,70)) +
  labs(title='weekly cases change', subtitle='compared to 2 weeks ago') +
  theme_void() +
  theme(legend.position='right',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))



subDT <- merge(eut, 
               movement[week==endweek,],
               by.x='NUTS_ID', by.y='geo_id_final', all.x=FALSE, all.y=FALSE)
setorder(subDT, LEVL_CODE, NUTS_ID, order)
subDT[colour=='Grey - no data', colour := 'grey50']

p4 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=colour)) +
  geom_polygon(colour='transparent') +
  scale_fill_identity() +
  coord_map(projection='azequidistant', xlim=c(-8, 33), ylim=c(36,70)) +
  labs(title='"traffic light" risk level') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))


print( (p1 | p4) / (p2 | p3) )

ggsave(( (p1 | p4) / (p2 | p3) ), file=file.path(dirpath, 'EU_sub.png'), device = png(),
       scale = 1, width = 11, height = 10, units = "cm", dpi = 300, limitsize = TRUE)
```


### Zoom on selected countries

```{r austria, fig.height=7, fig.width=14}
subDT <- merge(eut, 
               subnatcaseweek[year_week==endweek & country=='Austria',],
               by.x='NUTS_ID', by.y='nuts_code', all.x=FALSE, all.y=FALSE)
setorder(subDT, LEVL_CODE, NUTS_ID, order)


p1 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=rate_14_day_per_100k)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient(low='white', high=case_col, name='per 100000') +
  coord_map(projection='azequidistant') +
  labs(title='weekly wases') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))



subDT <- merge(eut, 
               subnatcaseweek[year_week %in% recentweeks[c(1,3)] & country=='Austria',],
               by.x='NUTS_ID', by.y='nuts_code', all.x=FALSE, all.y=FALSE)
subDT[, diff1 := rate_14_day_per_100k - shift(rate_14_day_per_100k, type='lag'), by=country]
subDT[, diff2 := rate_14_day_per_100k - shift(rate_14_day_per_100k, n=2, type='lag'), by=country]
setorder(subDT, LEVL_CODE, NUTS_ID, order)


p2 <- ggplot(subDT[year_week==endweek,],
       aes(x=long, y=lat, group=group,
           fill=diff1)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='forestgreen', mid='white', high='magenta', name='per 100000') +
  coord_map(projection='azequidistant') +
  labs(title='weekly cases change', subtitle='compared to previous week') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))

p3 <- ggplot(subDT[year_week==endweek,],
       aes(x=long, y=lat, group=group,
           fill=diff2)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='forestgreen', mid='white', high='magenta', name='per 100000') +
  coord_map(projection='azequidistant') +
  labs(title='weekly cases change', subtitle='compared to 2 weeks ago') +
  theme_void() +
  theme(legend.position='right',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))



subDT <- merge(eut, 
               movement[week==endweek & country=='Austria',],
               by.x='NUTS_ID', by.y='geo_id_final', all.x=FALSE, all.y=FALSE)
setorder(subDT, LEVL_CODE, NUTS_ID, order)
subDT[colour=='Grey - no data', colour := 'grey50']

p4 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=colour)) +
  geom_polygon(colour='transparent') +
  scale_fill_identity() +
  coord_map(projection='azequidistant') +
  labs(title='"traffic light" risk level') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))


print( (p1 | p4) / (p2 | p3) )

ggsave(( (p1 | p4) / (p2 | p3) ), file=file.path(dirpath, 'Austria_sub.png'), device = png(),
       scale = 1, width = 14, height = 7, units = "cm", dpi = 300, limitsize = TRUE)
```

```{r greece, fig.height=10, fig.width=14}
subDT <- merge(eut, 
               subnatcaseweek[year_week==endweek & country=='Greece',],
               by.x='NUTS_ID', by.y='nuts_code', all.x=FALSE, all.y=FALSE)
setorder(subDT, LEVL_CODE, NUTS_ID, order)


p1 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=rate_14_day_per_100k)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient(low='white', high=case_col, name='per 100000') +
  coord_map(projection='azequidistant', xlim=c(20, 28.5)) +
  labs(title='weekly wases') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))



subDT <- merge(eut, 
               subnatcaseweek[year_week %in% recentweeks[c(1,3)] & country=='Greece',],
               by.x='NUTS_ID', by.y='nuts_code', all.x=FALSE, all.y=FALSE)
subDT[, diff1 := rate_14_day_per_100k - shift(rate_14_day_per_100k, type='lag'), by=country]
subDT[, diff2 := rate_14_day_per_100k - shift(rate_14_day_per_100k, n=2, type='lag'), by=country]
setorder(subDT, LEVL_CODE, NUTS_ID, order)


p2 <- ggplot(subDT[year_week==endweek,],
       aes(x=long, y=lat, group=group,
           fill=diff1)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='forestgreen', mid='white', high='magenta', name='per 100000') +
  coord_map(projection='azequidistant', xlim=c(20, 28.5)) +
  labs(title='weekly cases change', subtitle='compared to previous week') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))

p3 <- ggplot(subDT[year_week==endweek,],
       aes(x=long, y=lat, group=group,
           fill=diff2)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='forestgreen', mid='white', high='magenta', name='per 100000') +
  coord_map(projection='azequidistant', xlim=c(20, 28.5)) +
  labs(title='weekly cases change', subtitle='compared to 2 weeks ago') +
  theme_void() +
  theme(legend.position='right',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))



subDT <- merge(eut, 
               movement[week==endweek & country=='Greece',],
               by.x='NUTS_ID', by.y='geo_id_final', all.x=FALSE, all.y=FALSE)
setorder(subDT, LEVL_CODE, NUTS_ID, order)
subDT[colour=='Grey - no data', colour := 'grey50']

p4 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=colour)) +
  geom_polygon(colour='transparent') +
  scale_fill_identity() +
  coord_map(projection='azequidistant', xlim=c(20, 28.5)) +
  labs(title='"traffic light" risk level') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))


print( (p1 | p4) / (p2 | p3) )

ggsave(( (p1 | p4) / (p2 | p3) ), file=file.path(dirpath, 'Greece_sub.png'), device = png(),
       scale = 1, width = 14, height = 10, units = "cm", dpi = 300, limitsize = TRUE)
```

```{r italy, fig.height=14, fig.width=14}
subDT <- merge(eut, 
               subnatcaseweek[year_week==endweek & country=='Italy',],
               by.x='NUTS_ID', by.y='nuts_code', all.x=FALSE, all.y=FALSE)
setorder(subDT, LEVL_CODE, NUTS_ID, order)


p1 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=rate_14_day_per_100k)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient(low='white', high=case_col, name='per 100000') +
  coord_map(projection='azequidistant') +
  labs(title='weekly wases') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))



subDT <- merge(eut, 
               subnatcaseweek[year_week %in% recentweeks[c(1,3)] & country=='Italy',],
               by.x='NUTS_ID', by.y='nuts_code', all.x=FALSE, all.y=FALSE)
subDT[, diff1 := rate_14_day_per_100k - shift(rate_14_day_per_100k, type='lag'), by=country]
subDT[, diff2 := rate_14_day_per_100k - shift(rate_14_day_per_100k, n=2, type='lag'), by=country]
setorder(subDT, LEVL_CODE, NUTS_ID, order)


p2 <- ggplot(subDT[year_week==endweek,],
       aes(x=long, y=lat, group=group,
           fill=diff1)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='forestgreen', mid='white', high='magenta', name='per 100000') +
  coord_map(projection='azequidistant') +
  labs(title='weekly cases change', subtitle='compared to previous week') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))

p3 <- ggplot(subDT[year_week==endweek,],
       aes(x=long, y=lat, group=group,
           fill=diff2)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='forestgreen', mid='white', high='magenta', name='per 100000') +
  coord_map(projection='azequidistant') +
  labs(title='weekly cases change', subtitle='compared to 2 weeks ago') +
  theme_void() +
  theme(legend.position='right',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))



subDT <- merge(eut, 
               movement[week==endweek & country=='Italy',],
               by.x='NUTS_ID', by.y='geo_id_final', all.x=FALSE, all.y=FALSE)
setorder(subDT, LEVL_CODE, NUTS_ID, order)
subDT[colour=='Grey - no data', colour := 'grey50']

p4 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=colour)) +
  geom_polygon(colour='transparent') +
  scale_fill_identity() +
  coord_map(projection='azequidistant') +
  labs(title='"traffic light" risk level') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))


print( (p1 | p4) / (p2 | p3) )

ggsave(( (p1 | p4) / (p2 | p3) ), file=file.path(dirpath, 'Italy_sub.png'), device = png(),
       scale = 1, width = 14, height = 14, units = "cm", dpi = 300, limitsize = TRUE)
```

```{r germany, fig.height=11, fig.width=10}
subDT <- merge(eut, 
               subnatcaseweek[year_week==endweek & country=='Germany',],
               by.x='NUTS_ID', by.y='nuts_code', all.x=FALSE, all.y=FALSE)
setorder(subDT, LEVL_CODE, NUTS_ID, order)


p1 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=rate_14_day_per_100k)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient(low='white', high=case_col, name='per 100000') +
  coord_map(projection='azequidistant') +
  labs(title='weekly wases') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))



subDT <- merge(eut, 
               subnatcaseweek[year_week %in% recentweeks[c(1,3)] & country=='Germany',],
               by.x='NUTS_ID', by.y='nuts_code', all.x=FALSE, all.y=FALSE)
subDT[, diff1 := rate_14_day_per_100k - shift(rate_14_day_per_100k, type='lag'), by=country]
subDT[, diff2 := rate_14_day_per_100k - shift(rate_14_day_per_100k, n=2, type='lag'), by=country]
setorder(subDT, LEVL_CODE, NUTS_ID, order)


p2 <- ggplot(subDT[year_week==endweek,],
       aes(x=long, y=lat, group=group,
           fill=diff1)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='forestgreen', mid='white', high='magenta', name='per 100000') +
  coord_map(projection='azequidistant') +
  labs(title='weekly cases change', subtitle='compared to previous week') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))

p3 <- ggplot(subDT[year_week==endweek,],
       aes(x=long, y=lat, group=group,
           fill=diff2)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='forestgreen', mid='white', high='magenta', name='per 100000') +
  coord_map(projection='azequidistant') +
  labs(title='weekly cases change', subtitle='compared to 2 weeks ago') +
  theme_void() +
  theme(legend.position='right',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))



subDT <- merge(eut, 
               movement[week==endweek & country=='Germany',],
               by.x='NUTS_ID', by.y='geo_id_final', all.x=FALSE, all.y=FALSE)
setorder(subDT, LEVL_CODE, NUTS_ID, order)
subDT[colour=='Grey - no data', colour := 'grey50']

p4 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=colour)) +
  geom_polygon(colour='transparent') +
  scale_fill_identity() +
  coord_map(projection='azequidistant') +
  labs(title='"traffic light" risk level') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue),
        panel.grid = element_line(colour='grey90'))


print( (p1 | p4) / (p2 | p3) )

ggsave(( (p1 | p4) / (p2 | p3) ), file=file.path(dirpath, 'Germany_sub.png'), device = png(),
       scale = 1, width = 14, height = 14, units = "cm", dpi = 300, limitsize = TRUE)
```


## Top 10s

Subject to available information. The ECDC may not maintain up-to-date/any information for some non-european countries.

### World's current worst

#### By cases

```{r wtopcase}
# Worse 10 (or more) by weekly cases
subDT <- natcasedeath[year_week==endweek & !is.na(weekly_count) & indicator=='cases', 
                  .(country, weekly_count, population_normalized = weekly_count / population * popnorm)] [order(weekly_count, decreasing=TRUE), ] [!grepl('(total)', country),]

n <- max(10, nrow(subDT[sapply(subDT$weekly_count, 
                               function(x) { 
                                 all.equal(subDT$weekly_count[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

#### By deaths

```{r wtopdeath}
# Worse 10 (or more) by weekly deaths
subDT <- natcasedeath[year_week==endweek & !is.na(weekly_count) & indicator=='deaths', 
                  .(country, weekly_count, population_normalized = weekly_count / population * popnorm)] [order(weekly_count, decreasing=TRUE), ] [!grepl('(total)', country),]

n <- max(10, nrow(subDT[sapply(subDT$weekly_count, 
                               function(x) { 
                                 all.equal(subDT$weekly_count[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

### Europe's current worst

#### By cases

```{r eutopcase}
# Worse 10 (or more) by weekly cases
subDT <- natcasedeath[year_week==endweek & !is.na(weekly_count) & indicator=='cases' & continent=='Europe', 
                  .(country, weekly_count, population_normalized = weekly_count / population * popnorm)] [order(weekly_count, decreasing=TRUE), ] [!grepl('(total)', country),]

n <- max(10, nrow(subDT[sapply(subDT$weekly_count, 
                               function(x) { 
                                 all.equal(subDT$weekly_count[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

#### By deaths

```{r eutopdeath}
# Worse 10 (or more) by weekly deaths
subDT <- natcasedeath[year_week==endweek & !is.na(weekly_count) & indicator=='deaths' & continent=='Europe', 
                  .(country, weekly_count, population_normalized = weekly_count / population * popnorm)] [order(weekly_count, decreasing=TRUE), ] [!grepl('(total)', country),]

n <- max(10, nrow(subDT[sapply(subDT$weekly_count, 
                               function(x) { 
                                 all.equal(subDT$weekly_count[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

### Europe's current best

#### By cases

```{r eutopcase2}
# Best 10 (or more) by weekly cases
subDT <- natcasedeath[year_week==endweek & !is.na(weekly_count) & indicator=='cases' & continent=='Europe', 
                  .(country, weekly_count, population_normalized = weekly_count / population * popnorm)] [order(weekly_count, decreasing=FALSE), ] [!grepl('(total)', country),]

n <- max(10, nrow(subDT[sapply(subDT$weekly_count, 
                               function(x) { 
                                 all.equal(subDT$weekly_count[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

#### By deaths

```{r eutopdeath2}
# Best 10 (or more) by weekly deaths
subDT <- natcasedeath[year_week==endweek & !is.na(weekly_count) & indicator=='deaths' & continent=='Europe', 
                  .(country, weekly_count, population_normalized = weekly_count / population * popnorm)] [order(weekly_count, decreasing=FALSE), ] [!grepl('(total)', country),]

n <- max(10, nrow(subDT[sapply(subDT$weekly_count, 
                               function(x) { 
                                 all.equal(subDT$weekly_count[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```


## Countries of personal interest

Ranked from worse to best.

```{r interest}
natcasedeath[year_week==endweek & indicator=='cases', global_rank := length(unique(natcasedeath$country)) - rank(population_normalized)]
natcasedeath[year_week==endweek & indicator=='cases' & continent=='Europe', european_rank := length(unique(natcasedeath[continent=='Europe', country])) - rank(population_normalized)]
  
print( natcasedeath[year_week==endweek & indicator=='cases' & country %in% family_countries, .(country, weekly_cases=weekly_count, population_normalized, global_rank, european_rank),] [order(european_rank),] )

natcasedeath[year_week==endweek & indicator=='deaths', global_rank := length(unique(natcasedeath$country)) - rank(population_normalized)]
natcasedeath[year_week==endweek & indicator=='deaths' & continent=='Europe', european_rank := length(unique(natcasedeath[continent=='Europe', country])) - rank(population_normalized)]
  
print( natcasedeath[year_week==endweek & indicator=='deaths' & country %in% family_countries, .(country, weekly_deaths=weekly_count, population_normalized, global_rank, european_rank),] [order(european_rank),] )
```

Ranked from worse to best locally.

```{r interest2}
ncountries <- length(unique(natcasedeath[continent=='Europe',]$country))

print( 
  natcasedeath[year_week==endweek & indicator=='cases', .(country, year_week, weekly_cases = weekly_count, population_normalized, global_rank = ncountries - rank(population_normalized))] [country %in% family_countries,] [order(global_rank), ] )

print( 
  natcasedeath[year_week==endweek & indicator=='deaths', .(country, year_week, weekly_deaths = weekly_count, population_normalized, global_rank = ncountries - rank(population_normalized))] [country %in% family_countries,] [order(global_rank), ] )
```


# Progression

<!-- ## GIF Maps -->

<!-- ```{r pregif} -->
<!-- subDT <- merge(world_map[, .(region, long, lat, group, order)], -->
<!--                casedist[, .(countriesAndTerritories, popData2019, cases_weekly, deaths_weekly, dateRep)], -->
<!--                by.x='region', by.y='countriesAndTerritories', all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE) -->
<!-- ``` -->

<!-- ### World -->

<!-- ```{r gifw, fig.height=7, fig.width=12} -->
<!-- anim <- ggplot(subDT) + -->
<!--   geom_polygon(aes(x=long, y=lat, group=group, fill=cases_weekly / popData2019 * popnorm), -->
<!--                colour='black', size=0.01) + -->
<!--   transition_states(dateRep, transition_length = 0, state_length = 1, wrap=TRUE) + -->
<!--   scale_fill_gradient(low='white', high=case_col, na.value='grey50', name=paste('per', popnorm)) + -->
<!--   coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic -->
<!--   labs(title='Weekly cases: {closest_state}') + -->
<!--   theme(panel.background=element_rect(fill=seablue), -->
<!--         panel.grid=element_line(colour='white', size=0.1)) -->

<!-- gif <- animate(anim, duration=30, end_pause=15,  -->
<!--                 width=1200, height=700, renderer=gifski_renderer() ) -->

<!-- anim_save(file.path(dirpath,'world_cases.gif'), animation=gif) -->

<!-- gif -->
<!-- ``` -->

<!-- ```{r gifw2, fig.height=7, fig.width=12} -->
<!-- anim <- ggplot(subDT) + -->
<!--   geom_polygon(aes(x=long, y=lat, group=group, fill=deaths_weekly / popData2019 * popnorm), -->
<!--                colour='black', size=0.01) + -->
<!--   transition_states(dateRep, transition_length = 0, state_length = 1, wrap=TRUE) + -->
<!--   scale_fill_gradient(low='white', high=death_col, na.value='grey50', name=paste('per', popnorm)) + -->
<!--   coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic -->
<!--   labs(title='Weekly deaths: {closest_state}') + -->
<!--   theme(panel.background=element_rect(fill=seablue), -->
<!--         panel.grid=element_line(colour='white', size=0.1)) -->

<!-- gif <- animate(anim, duration=30, end_pause=15,  -->
<!--                 width=1200, height=700, renderer=gifski_renderer() ) -->

<!-- anim_save(file.path(dirpath,'world_deaths.gif'), animation=gif) -->

<!-- gif -->
<!-- ``` -->

<!-- ### Europe -->

<!-- ```{r gife, fig.height=7, fig.width=10} -->
<!-- anim <- ggplot(subDT) + -->
<!--   geom_polygon(aes(x=long, y=lat, group=group, fill=cases_weekly / popData2019 * popnorm), -->
<!--                colour='black', size=0.01) + -->
<!--   transition_states(dateRep, transition_length = 0, state_length = 1, wrap=TRUE) + -->
<!--   scale_fill_gradient(low='white', high=case_col, na.value='grey50', name=paste('per', popnorm)) + -->
<!--   coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) + -->
<!--   labs(title='Weekly cases: {closest_state}') + -->
<!--   theme(panel.background=element_rect(fill=seablue), -->
<!--         panel.grid=element_line(colour='white', size=0.1)) -->

<!-- gif <- animate(anim, duration=30, end_pause=15,  -->
<!--                 width=1000, height=700, renderer=gifski_renderer() ) -->

<!-- anim_save(file.path(dirpath,'europe_cases.gif'), animation=gif) -->

<!-- gif -->
<!-- ``` -->

<!-- ```{r gife2, fig.height=7, fig.width=10} -->
<!-- anim <- ggplot(subDT) + -->
<!--   geom_polygon(aes(x=long, y=lat, group=group, fill=deaths_weekly / popData2019 * popnorm), -->
<!--                colour='black', size=0.01) + -->
<!--   transition_states(dateRep, transition_length = 0, state_length = 1, wrap=TRUE) + -->
<!--   scale_fill_gradient(low='white', high=death_col, na.value='grey50', name=paste('per', popnorm)) + -->
<!--   coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) + -->
<!--   labs(title='Weekly deaths: {closest_state}') + -->
<!--   theme(panel.background=element_rect(fill=seablue), -->
<!--         panel.grid=element_line(colour='white', size=0.1)) -->

<!-- gif <- animate(anim, duration=30, end_pause=15,  -->
<!--                 width=1000, height=700, renderer=gifski_renderer() ) -->

<!-- anim_save(file.path(dirpath,'europe_deaths.gif'), animation=gif) -->

<!-- gif -->
<!-- ``` -->


## Plots

```{r cumulative}
# Need 2 country variables to simultaneously differentially display some stuff and all stuff.
natcasedeath[, country2 := country]
# A numeric week helps keep the axis uncluttered
setorder(natcasedeath, -year_week, country)
natcasedeath[, week := -1*(1:nrow(.SD)), by=c('country', 'indicator')]
setorder(subnatcaseweek, -year_week, nuts_code)
subnatcaseweek[, week := -1*(1:nrow(.SD)), by=c('country', 'nuts_code')]
# In exponential growth, new cases are proportional to the total cases.
setorder(natcasedeath, year_week, country)
setorder(subnatcaseweek, year_week, country, nuts_code)
```

### Growth in selected countries

New events relative to total events. In exponential growth, the new events are proportional to the total events.

```{r expo, fig.width=10, fig.height=15}
# New vs Total
expo <- function(selcnt=family_countries){
  # Prime a dummy table to graft things onto
  pileup <- data.table(weekly_count=NA_integer_,
                       country=NA_character_,
                       indicator=NA_character_,
                       cumulative_count=NA_integer_,
                       country2=NA_integer_)
  # Graft
  for (cnt in selcnt){
    clonecd <- copy(natcasedeath[, .(weekly_count, indicator, country, cumulative_count, country2)])
    clonecd[, country := cnt]
    pileup <- rbind(pileup, clonecd)
  }
  # Lose the primer
  pileup <- pileup[2:nrow(pileup),]

  # Plot
  p1 <- ggplot(pileup, 
       aes(x=cumulative_count, y=weekly_count,
           group=country2)) +       # colouring by `country` doesn't create the right result
    facet_grid(country ~ indicator) +
    geom_line(colour='black', size=0.5, alpha=0.1) +
    scale_x_log10() +
    scale_y_log10() +
    geom_line(data=natcasedeath[country %in% selcnt,], 
              aes(colour=indicator), size=1, alpha=1) +
    coord_cartesian(ylim=c(1,NA), xlim=c(1,NA)) +
    scale_colour_manual(values=c(case_col, death_col), guide='none') +
    annotation_logticks(base=10, sides='lbrt') +
    theme_bw()
    
  return( p1 )
}
  
for (x in list(family_countries, 
              c(homecountry, neighbour_countries), 
              c(homecountry, other_countries),
              c(homecountry, holiday_options))) {
  p <- expo(x)
  print( p )
  ggsave(p, file=file.path(dirpath,paste(paste(x, collapse='-'), 'expo.png', sep='_')), device='png')
}
```

### Waves in selected countries

The previous does not take recovery into account. Only active infections create new cases. This gives the false impression that subsequent waves are steeper.
Using the cumulative cases in a smaller 4-week rolling window as approximation of active cases alleviates that illusion.

The first 50% of time is black, the next 25% is purple, the final 25% is red or blue.

```{r wave, fig.width=10, fig.height=15}
# Use 4-week rolling sum as an approximation for active total.
natcasedeath[, monthly_count := frollsum(weekly_count, n=4), by=c('country', 'indicator')]

# New vs Monthly
wave <- function(selcnt=family_countries){
  # Cases and deaths need completely different Y scales.
  p1 <- ggplot(natcasedeath[country %in% selcnt & indicator=='cases',],
           aes(x=monthly_count / population * popnorm, 
               y=weekly_count / population * popnorm,
               colour=week, group=country)) +
    facet_grid(country ~ ., scales='fixed') +
    geom_point(shape=16, size=rel(1)) +
    geom_point(data=natcasedeath[country %in% selcnt & indicator=='cases' & year_week==endweek,], shape=17, size=rel(1.8)) +
    geom_path(size=1) +
    scale_colour_gradientn(colours=c('black','black', 'purple', case_col), guide='none') +
    coord_cartesian(xlim=c(0,NA), ylim=c(0,NA)) +
    labs(title='Waves', x=paste('Monthly cases per', popnorm), y=paste('Weekly cases per', popnorm)) +
    theme_bw() +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))
  
  p2 <- ggplot(natcasedeath[country %in% selcnt & indicator=='deaths',],
           aes(x=monthly_count / population * popnorm, 
               y=weekly_count / population * popnorm,
               colour=week, group=country)) +
    facet_grid(country ~ ., scales='fixed') +
    geom_point(shape=16, size=rel(1)) +
    geom_point(data=natcasedeath[country %in% selcnt & indicator=='deaths' & year_week==endweek,], shape=17, size=rel(1.8)) +
    geom_path(size=1) +
    scale_colour_gradientn(colours=c('black','black', 'purple', death_col), guide='none') +
    coord_cartesian(xlim=c(0,NA), ylim=c(0,NA)) +
    labs(x=paste('Monthly deaths per', popnorm), y=paste('Weekly deaths per', popnorm)) +
    theme_bw() +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))
  
  return( p1 | p2 )
}

for (x in list(family_countries, 
              c(homecountry, neighbour_countries), 
              c(homecountry, other_countries),
              c(homecountry, holiday_options))) {
  p <- wave(x)
  print( p )
  ggsave(p, file=file.path(dirpath,paste(paste(x, collapse='-'), 'wave.png', sep='_')), device='png')
}
```

### Waves in regiond of selected countries

Using the cumulative cases in a smaller 4-week rolling window as approximation of active cases.

The first 50% of time is black, the next 25% is purple, the final 25% is red or blue.

```{r subwave, fig.width=15, fig.height=15}
# Use 4-week rolling sum as an approximation for active total.
subnatcaseweek[, monthly_count := frollsum(rate_14_day_per_100k, n=4), by=c('country', 'nuts_code')]

# New vs Monthly
subwave <- function(selcnt='Austria'){
  # Cases and deaths need completely different Y scales.
  p1 <- ggplot(subnatcaseweek[country==selcnt,],
           aes(x=monthly_count, 
               y=rate_14_day_per_100k,
               colour=week)) +
    facet_wrap(~ region_name, scales='fixed') +
    geom_point(shape=16, size=rel(1)) +
    geom_point(data=subnatcaseweek[country %in% selcnt & year_week==endweek,], shape=17, size=rel(1.8)) +
    geom_path(size=1) +
    scale_colour_gradientn(colours=c('black','black', 'purple', case_col), guide='none') +
    coord_cartesian(xlim=c(0,NA), ylim=c(0,NA)) +
    labs(title='Waves', x='Monthly cases per 100000', y='Weekly cases per 100000') +
    theme_bw() +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))
  
  return( p1 )
}

for (x in family_countries) {
  p <- subwave(x)
  print( p )
  ggsave(p, file=file.path(dirpath,paste(x, 'wave.png', sep='_')), device='png')
}
```

### Timeline in selected countries

A conventional view as function of time.

```{r time, fig.width=10, fig.height=15}
tline <- function(selcnt=family_countries){
  p1 <- ggplot(natcasedeath[country %in% selcnt & indicator=='cases',],
           aes(x=week, y=weekly_count / population * popnorm,
               colour=week, group=country)) +
    facet_grid(country ~ ., scales='fixed') +
    geom_path(size=1) +
    coord_cartesian(ylim=c(0,NA)) +
    scale_colour_gradientn(colours=c('black','black', 'purple', case_col), guide='none') +
    labs(title='Timeline', y=paste('Weekly cases per', popnorm)) +
    theme_bw()
  
  
  p2 <- ggplot(natcasedeath[country %in% selcnt & indicator=='deaths',],
           aes(x=week, y=weekly_count / population * popnorm,
               colour=week, group=country)) +
    facet_grid(country ~ ., scales='fixed') +
    geom_path(size=1) +
    coord_cartesian(ylim=c(0,NA)) +
    scale_colour_gradientn(colours=c('black','black', 'purple', death_col), guide='none') +
    labs(title='Timeline', y=paste('Weekly deaths per', popnorm)) +
    theme_bw()
  
  return( p1 | p2 )  
}

for (x in list(family_countries, 
              c(homecountry, neighbour_countries), 
              c(homecountry, other_countries),
              c(homecountry, holiday_options))) {
  p <- tline(x)
  print( p )
  ggsave(p, file=file.path(dirpath, paste(paste(x, collapse='-'), 'tline.png', sep='_')), device='png')
}
```

### Timeline in regions of selected countries

A conventional view as function of time.

```{r subtime, fig.width=15, fig.height=15}
subtline <- function(selcnt='Austria'){
  p1 <- ggplot(subnatcaseweek[country==selcnt,],
           aes(x=week, y= rate_14_day_per_100k,
               colour=region_name)) +
    facet_wrap(~ region_name, scales='fixed') +
    geom_path(size=1) +
    coord_cartesian(ylim=c(0,NA)) +
    labs(title='Timeline', y=paste('Weekly cases per', popnorm)) +
    theme_bw() +
    theme(legend.position='none')
  
  return( p1 )  
}

for (x in family_countries) {
  p <- subtline(x)
  print( p )
  ggsave(p, file=file.path(dirpath, paste(x, 'tline.png', sep='_')), device='png')
}
```

