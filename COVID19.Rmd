---
title: "COVID19"
author: "Kimon"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```

# Libraries

```{r message=FALSE}
library(httr)
library(lubridate)
library(ggplot2)
library(ggrepel)
library(patchwork)
library(data.table)
library(maps)

options(scipen=2)
```

Source: https://opendata.ecdc.europa.eu/covid19/

# Load current data

```{r}
# Load data
###########

## Download latest data
# GET("https://opendata.ecdc.europa.eu/covid19/agecasesnational/csv", authenticate(":", ":", type="ntlm"), write_disk('D:/Documents/covid/agecasesnational.csv', overwrite = TRUE))
# GET("https://opendata.ecdc.europa.eu/covid19/agecasesubnational/csv", authenticate(":", ":", type="ntlm"), write_disk('D:/Documents/covid/agecasesubnational.csv', overwrite = TRUE))
# GET("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", authenticate(":", ":", type="ntlm"), write_disk('D:/Documents/covid/casedistribution.csv', overwrite = TRUE))
# GET("https://opendata.ecdc.europa.eu/covid19/hospitalicuadmissionrates/csv", authenticate(":", ":", type="ntlm"), write_disk('D:/Documents/covid/hospitalicuadmissionrates.csv', overwrite = TRUE))
# GET("https://opendata.ecdc.europa.eu/covid19/movementindicators/csv", authenticate(":", ":", type="ntlm"), write_disk('D:/Documents/covid/movementindicators.csv', overwrite = TRUE))
# GET("https://opendata.ecdc.europa.eu/covid19/nationalcasedeath/csv", authenticate(":", ":", type="ntlm"), write_disk('D:/Documents/covid/nationalcasedeath.csv', overwrite = TRUE))
# GET("https://opendata.ecdc.europa.eu/covid19/subnationalcasedaily/csv", authenticate(":", ":", type="ntlm"), write_disk('D:/Documents/covid/subnationalcasedaily.csv', overwrite = TRUE))
# GET("https://opendata.ecdc.europa.eu/covid19/subnationalcaseweekly/csv", authenticate(":", ":", type="ntlm"), write_disk('D:/Documents/covid/subnationalcaseweekly.csv', overwrite = TRUE))
# GET("https://opendata.ecdc.europa.eu/covid19/testing/csv", authenticate(":", ":", type="ntlm"), write_disk('D:/Documents/covid/testing.csv', overwrite = TRUE))

# Import data.
# Don't need the cruiseship.
agecasenat <- fread('D:/Documents/covid/agecasesnational.csv')[country != 'Cases_on_an_international_conveyance_Japan', ]
agecasesubnat <- fread('D:/Documents/covid/agecasesubnational.csv') # [country != 'Cases_on_an_international_conveyance_Japan',] # Still blank
casedist <- fread('D:/Documents/covid/casedistribution.csv')[countriesAndTerritories != 'Cases_on_an_international_conveyance_Japan', ]
hosprate <- fread('D:/Documents/covid/hospitalicuadmissionrates.csv')[country != 'Cases_on_an_international_conveyance_Japan', ]
movement <- fread('D:/Documents/covid/movementindicators.csv')[country != 'Cases_on_an_international_conveyance_Japan', ]
natcasedeath <- fread('D:/Documents/covid/nationalcasedeath.csv')[country != 'Cases_on_an_international_conveyance_Japan', ]
subnatcaseday <- fread('D:/Documents/covid/subnationalcasedaily.csv')[country != 'Cases_on_an_international_conveyance_Japan', ]
subnatcaseweek <- fread('D:/Documents/covid/subnationalcaseweekly.csv')[country != 'Cases_on_an_international_conveyance_Japan', ]
testing <- fread('D:/Documents/covid/testing.csv')[country != 'Cases_on_an_international_conveyance_Japan', ]

# Verify that the data format wasn't changed again
stopifnot(names(agecasenat) == c('country', 'country_code', 'year_week', 'age_group', 'new_cases', 'population', 'rate_14_day_per_100k', 'source'))
stopifnot(names(agecasesubnat) == c('Test'))
stopifnot(names(casedist) == c('dateRep', 'year_week', 'cases_weekly', 'deaths_weekly', 'countriesAndTerritories', 'geoId', 'countryterritoryCode', 'popData2019', 'continentExp', 'notification_rate_per_100000_population_14-days'))
stopifnot(names(hosprate) == c('country', 'indicator', 'date', 'year_week', 'value', 'source', 'url'))
stopifnot(names(movement) == c('col0', 'country', 'country_code', 'geo_id_final', 'region', 'subnational_cases_7', 'subnational_cases_14', 'subnational_population', 'subnational_rate_14', 'national_cases_7', 'national_population', 'national_testing_rate', 'national_positivity_rate', 'subnational_testing_data', 'positivity_rate_combined', 'testing_rate_combined', 'colour', 'week'))
stopifnot(names(natcasedeath) == c('country', 'country_code', 'continent', 'population', 'indicator', 'weekly_count', 'year_week', 'rate_14_day', 'cumulative_count', 'source'))
stopifnot(names(subnatcaseday) == c('country', 'region_name', 'nuts_code', 'date', 'rate_14_day_per_100k', 'source'))
stopifnot(names(subnatcaseweek) == c('country', 'region_name', 'nuts_code', 'year_week', 'rate_14_day_per_100k', 'source'))
stopifnot(names(testing) == c('country', 'country_code', 'year_week', 'level', 'region', 'region_name', 'new_cases', 'tests_done', 'population', 'testing_rate', 'positivity_rate', 'testing_data_source'))


# Countries to highlight
########################

homecountry = 'Austria'
# Selected countries
family_countries <- c('Austria', 'Italy', 'Greece', 'Luxembourg', 'Germany')
neighbour_countries <- c('Switzerland', 'Slovakia', 'Slovenia', 'Czechia', 'Hungary')
other_countries <- c('United_Kingdom', 'Spain', 'France', 'Belgium', 'United_States_of_America', 'Sweden', 'South_Korea')


# Make dates workable and uniform
#################################

# str(agecasenat)
##str(agecasesubnat)
# str(casedist)
casedist[, dateRep := dmy(dateRep)]
# str(hosprate)
hosprate[, date := as.Date(date)]
hosprate[, year_week := sub('W', '', year_week)]
# str(movement)
# str(natcasedeath)
# str(subnatcaseday)
subnatcaseday[, date := as.Date(date)]
# str(subnatcaseweek)
subnatcaseweek[, year_week := sub('W', '', year_week)]
# str(testing)
testing[, year_week := sub('W', '', year_week)]


# Map outlines
##############

world_map <- as.data.table(map_data('world'))

## Code template
# ggplot(world_map, aes(x=long, y=lat, group=group)) +
#   geom_polygon(fill='white', colour='black', size=0.01) +
#   coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
#   theme(panel.background=element_rect(fill=seablue),
#         panel.grid=element_line(colour='white', size=0.1))


# Sanitize country names

# Map data names allow spaces, ECDC uses underscores.
# Spaces are nice, but ECDC tables out-number the coordinates table, so it makes sense to keep the ECDC convention.
# Also, ECDC groups some of these territories together, whereas the map doesn't (except for the Virgin Islands, where it is the other way around)/
world_map[, region := gsub(' ', '_', region,)]

# More mismatched spellings.
world_map[region=='Antigua', region := 'Antigua_and_Barbuda']
world_map[region=='Bonaire', region := 'Bonaire, Saint Eustatius and Saba']
world_map[region=='Sint_Eustatius', region := 'Bonaire, Saint Eustatius and Saba']
world_map[region=='Saba', region := 'Bonaire, Saint Eustatius and Saba']
## world_map[region=='Virgin_Islands', region := 'British_Virgin_Islands']       # I could try to sum the ECDC data, but more trouble than it's worth. 
## world_map[region=='Virgin_Islands', region := 'United_States_Virgin_Islands'] # Fixing the report structure is the priority.
world_map[region=='Brunei', region := 'Brunei_Darussalam']
world_map[region=='Republic_of_Congo', region := 'Congo']
world_map[region=='Ivory_Coast', region := 'Cote_dIvoire']
world_map[region=='Curacao', region := 'CuraÃ§ao']
world_map[region=='Czech_Republic', region := 'Czechia']
world_map[region=='Falkland_Islands', region := 'Falkland_Islands_(Malvinas)']
world_map[region=='Guinea-Bissau', region := 'Guinea_Bissau']
world_map[region=='Vatican', region := 'Holy_See']
world_map[region=='Micronesia', region := 'Micronesia_(Federated_States_of)']
world_map[region=='Nevis', region := 'Saint_Kitts_and_Nevis']
world_map[region=='Saint_Kitts', region := 'Saint_Kitts_and_Nevis']
world_map[region=='Grenadines', region := 'Saint_Vincent_and_the_Grenadines']
world_map[region=='Saint_Vincent', region := 'Saint_Vincent_and_the_Grenadines']
world_map[region=='Macedonia', region := 'North_Macedonia']
world_map[region=='Timor-Leste', region := 'Timor_Leste']
world_map[region=='Trinidad', region := 'Trinidad_and_Tobago']
world_map[region=='Tobago', region := 'Trinidad_and_Tobago']
world_map[region=='Turks_and_Caicos_Islands', region := 'Turks_and_Caicos_islands']
world_map[region=='UK', region := 'United_Kingdom']
world_map[region=='Tanzania', region := 'United_Republic_of_Tanzania']
world_map[region=='USA', region := 'United_States_of_America']
world_map[region=='Swaziland', region := 'Eswatini']

# Countries that still don't match
print( data.frame(Only_in_the_data = setdiff(
  unique(casedist$countriesAndTerritories), 
  unique(world_map$region)) ) )
print( data.frame(Only_in_the_map = setdiff(
  unique(world_map$region), 
  unique(casedist$countriesAndTerritories)) ) )

 
# Add coordinates to the data tables
####################################

mapify <- function(dt, country1='country', country2='region') {
  merge(dt, world_map, by.x=country1, by.y=country2, all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE)
}

# Code templates
## Don't merge data with the coordinates yet. Leave it until after any calculations.
# agecasenat <- mapify(agecasenat)
# casedist <- mapify(casedist, 'countriesAndTerritories')
# hosprate <- mapify(hosprate)
# natcasedeath <- mapify(natcasedeath)
# testingnat <- mapify(testing[level == 'national',])
## These tables include subregional detail. Neither the data nor the coordinates have subregional info for all countries. So, merging on subregions is problematic, and merging on countries is not sensible for the kind of data.
# testingsubnat <- testing[level != 'national',]
## movement
## subnatcaseday
## subnatcaseweek

# Colours
#########
seablue <- '#CCEEFF'
case_col <- '#FF0000'
death_col <- '#0055FF'
hosp_col <- '#555500'
icu_col <- '#995500'
test_col <- '#005500'

# Normalization
popnorm= 1e6
```



# Status

```{r}
endday <- unique(casedist[dateRep == max(dateRep), dateRep])
startday <- unique(casedist[dateRep == min(dateRep), dateRep])
endweek <- unique(casedist[year_week == max(year_week), year_week])
startweek <- unique(casedist[year_week == max(year_week), year_week])
```

Based on the latest available date in the table. Some countries may be slower at releasing/entering their data, and not have current data to show.

## Maps

### Global

```{r, fig.height=12, fig.width=12}
subDT <- merge(world_map[, .(region, long, lat, group, order)], 
               casedist[year_week==endweek, .(countriesAndTerritories, popData2019, cases_weekly, deaths_weekly)], 
               by.x='region', by.y='countriesAndTerritories', all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE)

p1 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases_weekly)) +
  geom_polygon(colour='black', size=0.01) +
  coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=case_col, na.value='grey50') +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='white', size=0.1))

p2 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases_weekly / popData2019 * popnorm)) +
  geom_polygon(colour='black', size=0.01) +
  coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=case_col, na.value='grey50', name=paste('cases_weekly\nper', popnorm)) +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='white', size=0.1))

print( p1 / p2 )

p3 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths_weekly)) +
  geom_polygon(colour='black', size=0.01) +
  coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=death_col, na.value='grey50') +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='white', size=0.1))

p4 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths_weekly / popData2019 * popnorm)) +
  geom_polygon(colour='black', size=0.01) +
  coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=death_col, na.value='grey50', name=paste('deaths_weekly\nper', popnorm)) +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='white', size=0.1))


print( p3 / p4 )
```

### Europe

```{r, fig.height=12, fig.width=10}
subDT <- merge(world_map[, .(region, long, lat, group, order)], 
               casedist[year_week==endweek & continentExp=='Europe', .(countriesAndTerritories, popData2019, cases_weekly, deaths_weekly)], 
               by.x='region', by.y='countriesAndTerritories', all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE)

p1 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases_weekly)) +
  geom_polygon(colour='black', size=0.01) +
  coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=case_col, na.value='grey50') +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='white', size=0.1))

p2 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases_weekly / popData2019 * popnorm)) +
  geom_polygon(colour='black', size=0.01) +
  coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=case_col, na.value='grey50', name=paste('cases_weekly\nper', popnorm)) +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='white', size=0.1))

print( p1 / p2 )

p3 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths_weekly)) +
  geom_polygon(colour='black', size=0.01) +
  coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=death_col, na.value='grey50') +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='white', size=0.1))

p4 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths_weekly / popData2019 * popnorm)) +
  geom_polygon(colour='black', size=0.01) +
  coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=death_col, na.value='grey50', name=paste('deaths_weekly\nper', popnorm)) +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_line(colour='white', size=0.1))


print( p3 / p4 )
```



## Top 10s

### World's current worst

#### By cases

```{r}
# Worse 10 (or more) by weekly cases
subDT <- casedist[dateRep==endday & !is.na(cases_weekly), 
                  .(countriesAndTerritories, dateRep, cases_weekly, population_normalized = cases_weekly / popData2019 * popnorm)] [order(cases_weekly, decreasing=TRUE), ]

n <- max(10, nrow(subDT[sapply(subDT$cases_weekly, 
                               function(x) { 
                                 all.equal(subDT$cases_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

#### By deaths

```{r}
# Worse 10 (or more) by weekly deaths
subDT <- casedist[dateRep==endday & !is.na(deaths_weekly), 
                  .(countriesAndTerritories, dateRep, deaths_weekly, population_normalized = deaths_weekly / popData2019 * popnorm)] [order(deaths_weekly, decreasing=TRUE), ]

n <- max(10, nrow(subDT[sapply(subDT$deaths_weekly, 
                               function(x) { 
                                 all.equal(subDT$deaths_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )

# Worse 10 (or more) by weekly deaths normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

### Europe's current worst

#### By cases

```{r}
# Worse 10 (or more) by weekly cases
subDT <- casedist[dateRep==endday & !is.na(cases_weekly) & continentExp == 'Europe', 
                  .(countriesAndTerritories, dateRep, cases_weekly, population_normalized = cases_weekly / popData2019 * popnorm)] [order(cases_weekly, decreasing=TRUE), ]

n <- max(10, nrow(subDT[sapply(subDT$cases_weekly, 
                               function(x) { 
                                 all.equal(subDT$cases_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

#### By deaths

```{r}
# Worse 10 (or more) by weekly deaths
subDT <- casedist[dateRep==endday & !is.na(deaths_weekly) & continentExp == 'Europe', 
                  .(countriesAndTerritories, dateRep, deaths_weekly, population_normalized = deaths_weekly / popData2019 * popnorm)] [order(deaths_weekly, decreasing=TRUE), ]

n <- max(10, nrow(subDT[sapply(subDT$deaths_weekly, 
                               function(x) { 
                                 all.equal(subDT$deaths_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )

# Worse 10 (or more) by weekly deaths normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

### Europe's current best

#### By cases

```{r}
# Worse 10 (or more) by weekly cases
subDT <- casedist[dateRep==endday & !is.na(cases_weekly) & continentExp == 'Europe', 
                  .(countriesAndTerritories, dateRep, cases_weekly, population_normalized = cases_weekly / popData2019 * popnorm)] [order(cases_weekly, decreasing=FALSE), ]

n <- max(10, nrow(subDT[sapply(subDT$cases_weekly, 
                               function(x) { 
                                 all.equal(subDT$cases_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

##]# By deaths

```{r}
# Worse 10 (or more) by weekly deaths
subDT <- casedist[dateRep==endday & !is.na(deaths_weekly) & continentExp == 'Europe', 
                  .(countriesAndTerritories, dateRep, deaths_weekly, population_normalized = deaths_weekly / popData2019 * popnorm)] [order(deaths_weekly, decreasing=FALSE), ]

n <- max(10, nrow(subDT[sapply(subDT$deaths_weekly, 
                               function(x) { 
                                 all.equal(subDT$deaths_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )

# Worse 10 (or more) by weekly deaths normalized
setorder(subDT, population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

### Countries of personal interest

```{r}
print( 
  casedist[dateRep==endday & countriesAndTerritories %in% family_countries,
           .(countriesAndTerritories, dateRep, year_week, cases_weekly, population_normalized = cases_weekly / popData2019 * popnorm)] )

print( 
  casedist[dateRep==endday & countriesAndTerritories %in% family_countries,
           .(countriesAndTerritories, dateRep, year_week, deaths_weekly, population_normalized = cases_weekly / popData2019 * popnorm)] )


print( unique(
  movement[country %in% family_countries & week==endweek, 
           .(country, national_cases_7, national_positivity_rate)] ) )

print( 
  movement[country %in% family_countries & week==endweek, 
           .(country, region, subnational_cases_7, subnational_cases_14, subnational_rate_14)] )
```





# Timeline



## Global

```{r, fig.height=8, fig.width=8, warning=FALSE}
subDT <- melt(unique(DT[, .(Date, gNew_Cases, gNew_Deaths, gTotal_Cases, gTotal_Deaths, gRoll_Cases, gRoll_Deaths)]),
							id.vars="Date", variable.name="Type", value.name="Events")

p1 <- ggplot(subDT, aes(x=Date, y=Events, colour=Type, fill=Type)) +
	facet_grid( sub('^g', '', sub('_Cases', '', sub('_Deaths', '', subDT$Type))) ~ ., scales = 'free_y') +
	geom_line() +
	theme_minimal() + 
	labs(x='', y='') +
	theme(legend.position='none')

p2 <- ggplot(subDT, aes(x=Date, y=Events, colour=Type, fill=Type)) +
	facet_grid( sub('^g', '', sub('_Cases', '', sub('_Deaths', '', subDT$Type))) ~ ., scales = 'free_y') +
	geom_line() +
	scale_y_log10() +
	labs(x='', y='') +
	theme_minimal()

print( p1 + p2 )

subDT <- unique(DT[, .(Date, gRoll_Cases_Rate, gRoll_Deaths_Rate, gMortality)])

p3 <- ggplot(subDT, aes(x=Date, y=gRoll_Cases_Rate)) +
	geom_hline(yintercept = 1, size=0.1) +
  geom_point(colour=case_col, size=0.5) +
	geom_smooth(span=0.2, colour=case_col, size=0.5) +
	coord_cartesian(ylim=c(0.8, 1.2)) +
	labs(title=paste('Daily change rate of ', W, '-day rolling sum')) +
	theme_bw()

p4 <- ggplot(subDT, aes(x=Date, y=gRoll_Deaths_Rate)) +
	geom_hline(yintercept = 1, size=0.1) +
  geom_point(colour=death_col, size=0.5) +
	geom_smooth(span=0.2, colour=death_col, size=0.5) +
	coord_cartesian(ylim=c(0.8, 1.2)) +
	labs(title='') +
		theme_bw()

p5 <- ggplot(subDT, aes(x=Date, y=gMortality)) +
	geom_hline(yintercept = 0, size=0.1) +
  geom_point(colour=death_col, size=0.5) +
	geom_smooth(span=0.3, colour=death_col, size=0.5) +
	labs(title='') +
		theme_bw()

print( p3 / p4 / p5 )
```

## Detailed

### Countries of personal interest

#### More plots

```{r, fig.height=20, fig.width=10, warning=FALSE}
for (i in topInterest) {
	more_plots(tidyDT, expDT, rateDT, i, homecountry)
  
  ggsave(paste0('~/covid/', i, '_more.png'), plot = last_plot(), scale = 1,
       width = 20, height = 40, units = "cm", dpi = 300, limitsize = TRUE)
}
```

#### Fewer plots

```{r, fig.height=15, fig.width=10, warning=FALSE}
for (i in topInterest) {
	fewer_plots(tidyDT[hsplit=='roll',], expDT, rateDT, i, homecountry)
  
  ggsave(paste0('~/covid/', i, '_fewer.png'), plot = last_plot(), scale = 1,
       width = 20, height = 40, units = "cm", dpi = 300, limitsize = TRUE)
}
```

## Comparative

### Selected countries

```{r, fig.height=20, fig.width=10, warning=FALSE}
countries <- c(topInterest, other_countries, neighbour_countries)

for (j in c('norm_roll_Cases', 'norm_roll_Deaths', 'norm_new_Tests')) {
	compare_numbers(tidyDT, j, countries)
  
  ggsave(paste0('~/covid/', j, '_comp.png'), plot = last_plot(), scale = 1,
       width = 30, height = 3 * length(countries), units = "cm", dpi = 300, limitsize = TRUE)
}

for (j in c('Cases', 'Deaths')) {
  compare_exp(expDT, j, 'norm_Total', 'norm_Roll', countries)
    
  ggsave(paste0('~/covid/', j, '_comp.png'), plot = last_plot(), scale = 1,
       width = 30, height = 3 * length(countries), units = "cm", dpi = 300, limitsize = TRUE)
  }
```


# Session

```{r}
sessionInfo()
```
