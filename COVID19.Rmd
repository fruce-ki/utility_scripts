---
title: "COVID19"
author: "Kimon"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)

dirpath <- 'D:/Documents/covid'
refresh <- FALSE
# refresh <- TRUE
```

```{r message=FALSE}
library(httr)
library(lubridate)
library(ggplot2)
library(broom)
library(patchwork)
library(data.table)
library(maps)
library(rgdal)
# library(gganimate)
library(utf8)

options(scipen=2)
```

Pandemic data source: European Centre for Disease Control https://opendata.ecdc.europa.eu/covid19/

Detailed European maps: EUROSTAT NUTS2021
http://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statisticalunits

# Load current data

```{r download}
# Get latest data
###########

if (refresh){
  GET("https://opendata.ecdc.europa.eu/covid19/agecasesnational/csv", 
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'agecasesnational.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/agecasesubnational/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'agecasesubnational.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'casedistribution.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/hospitalicuadmissionrates/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'hospitalicuadmissionrates.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/movementindicators/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'movementindicators.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/nationalcasedeath/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'nationalcasedeath.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/subnationalcasedaily/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'subnationalcasedaily.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/subnationalcaseweekly/csv",
      authenticate(":", ":", type="ntlm"),
      write_disk(file.path(dirpath,'subnationalcaseweekly.csv'), overwrite = TRUE))
  GET("https://opendata.ecdc.europa.eu/covid19/testing/csv", 
      authenticate(":", ":", type="ntlm"), 
      write_disk(file.path(dirpath,'testing.csv'), overwrite = TRUE))
}
```

```{r load}
# Import data.
# Don't need the cruiseship.
agecasenat <- fread(file.path(dirpath,'agecasesnational.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
agecasesubnat <- fread(file.path(dirpath,'agecasesubnational.csv')) # [country != 'Cases_on_an_international_conveyance_Japan',] # Still blank
casedist <- fread(file.path(dirpath,'casedistribution.csv'))[countriesAndTerritories != 'Cases_on_an_international_conveyance_Japan', ]
hosprate <- fread(file.path(dirpath,'hospitalicuadmissionrates.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
movement <- fread(file.path(dirpath,'movementindicators.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
natcasedeath <- fread(file.path(dirpath,'nationalcasedeath.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
subnatcaseday <- fread(file.path(dirpath,'subnationalcasedaily.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
subnatcaseweek <- fread(file.path(dirpath,'subnationalcaseweekly.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]
testing <- fread(file.path(dirpath,'testing.csv'))[country != 'Cases_on_an_international_conveyance_Japan', ]

# Verify that the data format wasn't changed again
stopifnot(names(agecasenat) == c('country', 'country_code', 'year_week', 'age_group', 'new_cases', 'population', 'rate_14_day_per_100k', 'source'))
stopifnot(names(agecasesubnat) == c('Test'))
stopifnot(names(casedist) == c('dateRep', 'year_week', 'cases_weekly', 'deaths_weekly', 'countriesAndTerritories', 'geoId', 'countryterritoryCode', 'popData2019', 'continentExp', 'notification_rate_per_100000_population_14-days'))
stopifnot(names(hosprate) == c('country', 'indicator', 'date', 'year_week', 'value', 'source', 'url'))
stopifnot(names(movement) == c('col0', 'country', 'country_code', 'geo_id_final', 'region', 'subnational_cases_7', 'subnational_cases_14', 'subnational_population', 'subnational_rate_14', 'national_cases_7', 'national_population', 'national_testing_rate', 'national_positivity_rate', 'subnational_testing_data', 'positivity_rate_combined', 'testing_rate_combined', 'colour', 'week'))
stopifnot(names(natcasedeath) == c('country', 'country_code', 'continent', 'population', 'indicator', 'weekly_count', 'year_week', 'rate_14_day', 'cumulative_count', 'source'))
stopifnot(names(subnatcaseday) == c('country', 'region_name', 'nuts_code', 'date', 'rate_14_day_per_100k', 'source'))
stopifnot(names(subnatcaseweek) == c('country', 'region_name', 'nuts_code', 'year_week', 'rate_14_day_per_100k', 'source'))
stopifnot(names(testing) == c('country', 'country_code', 'year_week', 'level', 'region', 'region_name', 'new_cases', 'tests_done', 'population', 'testing_rate', 'positivity_rate', 'testing_data_source'))


# Countries to highlight
########################

homecountry = 'Austria'
# Selected countries
family_countries <- c('Austria', 'Italy', 'Greece', 'Luxembourg', 'Germany')
neighbour_countries <- c('Switzerland', 'Slovakia', 'Slovenia', 'Czechia', 'Hungary')
other_countries <- c('United_Kingdom', 'Spain', 'France', 'Belgium', 'United_States_of_America', 'Sweden', 'South_Korea')
holiday_options=c('Croatia', 'Greece', 'Italy', 'Malta', 'Spain', 'Egypt')


# Make dates workable and uniform
#################################

# str(agecasenat)
##str(agecasesubnat)
# str(casedist)
casedist[, dateRep := dmy(dateRep)]
# str(hosprate)
hosprate[, date := as.Date(date)]
hosprate[, year_week := sub('W', '', year_week)]
# str(movement)
# str(natcasedeath)
# str(subnatcaseday)
subnatcaseday[, date := as.Date(date)]
# str(subnatcaseweek)
subnatcaseweek[, year_week := sub('W', '', year_week)]
# str(testing)
testing[, year_week := sub('W', '', year_week)]





# Map outlines
##############

# Simple world map
world_map <- as.data.table(map_data('world'))

## Code template
# ggplot(world_map, aes(x=long, y=lat, group=group)) +
#   geom_polygon(fill='white', colour='black', size=0.01) +
#   coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
#   theme(panel.background=element_rect(fill=seablue),
#         panel.grid=element_line(colour='white', size=0.1))

# Finer-detailed EU map.
# Covid data for some countries is recorded at NUTS level 2 and for some other at NUTS level 1.
eu2 <- readOGR(file.path(dirpath, 'ref-nuts-2021-01m.shp', 'NUTS_RG_01M_2021_3035_LEVL_2.shp'))
eu2@data['id'] <- as.character(seq.int(0, nrow(eu2@data)-1))
eu2t <- as.data.table(tidy(eu2))
eu2t <- merge(eu2t, eu2@data, by='id')

eu1 <- readOGR(file.path(dirpath, 'ref-nuts-2021-01m.shp', 'NUTS_RG_01M_2021_3035_LEVL_1.shp'))
eu1@data['id'] <- as.character(seq.int(0, nrow(eu1@data)-1))
eu1t <- as.data.table(tidy(eu1))
eu1t <- merge(eu1t, eu1@data, by='id')

eut <- rbind(eu1t, eu2t)
eut <- merge(eut, movement,
             by.x='NUTS_ID', by.y='geo_id_final', all.x=FALSE, all.y=FALSE)
setorder(eut, LEVL_CODE, NUTS_ID, order)

# Overseas territories of France, Spain and Portugal force too much zoom-out. 
# Remove them to focus on the continent.
eut <- eut[! NUTS_ID %in% c('ES70', 'FRY1', 'FRY2', 'FRY3', 'FRY4', 'FRY5', 'PT2', 'PT3'),]
# Fix illegal colour name
eut[(colour=='Grey - no data'), colour := 'grey50']

## Code template
# ggplot(subDT, 
#        aes(x=long, y=lat, group=group,
#            fill=subnational_population)) +
#   geom_polygon(colour='black')





# Sanitize country names

# Map data names allow spaces, ECDC uses underscores.
# Spaces are nice, but ECDC tables out-number the coordinates table, so it makes sense to keep the ECDC convention.
# Also, ECDC groups some of these territories together, whereas the map doesn't (except for the Virgin Islands, where it is the other way around)/
world_map[, region := gsub(' ', '_', region,)]

# More mismatched spellings.
world_map[region=='Antigua', region := 'Antigua_and_Barbuda']
world_map[region=='Bonaire', region := 'Bonaire, Saint Eustatius and Saba']
world_map[region=='Sint_Eustatius', region := 'Bonaire, Saint Eustatius and Saba']
world_map[region=='Saba', region := 'Bonaire, Saint Eustatius and Saba']
## world_map[region=='Virgin_Islands', region := 'British_Virgin_Islands']       # I could try to sum the ECDC data, but more trouble than it's worth. 
## world_map[region=='Virgin_Islands', region := 'United_States_Virgin_Islands'] # Fixing the report structure is the priority.
world_map[region=='Brunei', region := 'Brunei_Darussalam']
world_map[region=='Republic_of_Congo', region := 'Congo']
world_map[region=='Ivory_Coast', region := 'Cote_dIvoire']
world_map[region=='Curacao', region := 'CuraÃ§ao']
world_map[region=='Czech_Republic', region := 'Czechia']
world_map[region=='Falkland_Islands', region := 'Falkland_Islands_(Malvinas)']
world_map[region=='Guinea-Bissau', region := 'Guinea_Bissau']
world_map[region=='Vatican', region := 'Holy_See']
world_map[region=='Micronesia', region := 'Micronesia_(Federated_States_of)']
world_map[region=='Nevis', region := 'Saint_Kitts_and_Nevis']
world_map[region=='Saint_Kitts', region := 'Saint_Kitts_and_Nevis']
world_map[region=='Grenadines', region := 'Saint_Vincent_and_the_Grenadines']
world_map[region=='Saint_Vincent', region := 'Saint_Vincent_and_the_Grenadines']
world_map[region=='Macedonia', region := 'North_Macedonia']
world_map[region=='Timor-Leste', region := 'Timor_Leste']
world_map[region=='Trinidad', region := 'Trinidad_and_Tobago']
world_map[region=='Tobago', region := 'Trinidad_and_Tobago']
world_map[region=='Turks_and_Caicos_Islands', region := 'Turks_and_Caicos_islands']
world_map[region=='UK', region := 'United_Kingdom']
world_map[region=='Tanzania', region := 'United_Republic_of_Tanzania']
world_map[region=='USA', region := 'United_States_of_America']
world_map[region=='Swaziland', region := 'Eswatini']

# Countries that still don't match
print( data.frame(Only_in_the_data = setdiff(
  unique(casedist$countriesAndTerritories), 
  unique(world_map$region)) ) )
print( data.frame(Only_in_the_map = setdiff(
  unique(world_map$region), 
  unique(casedist$countriesAndTerritories)) ) )

 
# Add coordinates to the data tables
####################################

mapify <- function(dt, country1='country', country2='region') {
  merge(dt, world_map, by.x=country1, by.y=country2, all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE)
}

# Code templates
## Don't merge data with the coordinates yet. Leave it until after any calculations.
# agecasenat <- mapify(agecasenat)
# casedist <- mapify(casedist, 'countriesAndTerritories')
# hosprate <- mapify(hosprate)
# natcasedeath <- mapify(natcasedeath)
# testingnat <- mapify(testing[level == 'national',])
## These tables include subregional detail. Neither the data nor the coordinates have subregional info for all countries. So, merging on subregions is problematic, and merging on countries is not sensible for the kind of data.
# testingsubnat <- testing[level != 'national',]
## movement
## subnatcaseday
## subnatcaseweek

# Colours
#########
seablue <- 'black'
case_col <- '#FF0000'
death_col <- '#0055FF'
hosp_col <- '#555500'
icu_col <- '#995500'
test_col <- '#005500'

# Normalization
popnorm= 1e6
```


# Status

```{r status}
setorder(casedist, dateRep, countriesAndTerritories)

endday <- tail(casedist[, dateRep], 1)
startday <- head(casedist[, dateRep], 1)
endweek <- tail(casedist[, year_week], 1)
startweek <- head(casedist[, year_week], 1)

message(paste('First entry:', startday))
message(paste('Last update:', endday))
message(paste('Recording duration:', length(unique(casedist$year_week)), 'weeks'))
```

Based on the latest available date in the table. Some countries may be slower at releasing/entering their data, and not have current data to show.

## Maps

### Global

```{r global}
subDT <- merge(world_map[, .(region, long, lat, group, order)], 
               casedist[year_week==endweek, .(countriesAndTerritories, popData2019, cases_weekly, deaths_weekly)], 
               by.x='region', by.y='countriesAndTerritories', all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE)
```

```{r gcase, fig.height=12, fig.width=12}
p1 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases_weekly)) +
  geom_polygon(colour='transparent', size=0.01) +
  coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=case_col, na.value='grey50') +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank())

p2 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases_weekly / popData2019 * popnorm)) +
  geom_polygon(colour='transparent', size=0.01) +
  coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=case_col, na.value='grey50', name=paste('cases_weekly\nper', popnorm)) +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank())

print( p1 / p2 )

ggsave(file.path(dirpath,'world_cases.png'), plot = p1 / p2, device = png(), 
       scale = 1, width = 12, height = 12, units = "cm", dpi = 300, limitsize = TRUE)
```

```{r gdeath, fig.height=12, fig.width=12}
p3 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths_weekly)) +
  geom_polygon(colour='transparent', size=0.01) +
  coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=death_col, na.value='grey50') +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank())

p4 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths_weekly / popData2019 * popnorm)) +
  geom_polygon(colour='transparent', size=0.01) +
  coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic
  scale_fill_gradient(low='white', high=death_col, na.value='grey50', name=paste('deaths_weekly\nper', popnorm)) +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank())

print( p3 / p4 )

ggsave(file.path(dirpath,'world_deaths.png'), plot = p3 / p4, device = png(),
       scale = 1, width = 12, height = 12, units = "cm", dpi = 300, limitsize = TRUE)
```

### Europe

```{r europe, fig.height=12, fig.width=9}
subDT <- merge(world_map[, .(region, long, lat, group, order)], 
               casedist[year_week==endweek & continentExp=='Europe', .(countriesAndTerritories, popData2019, cases_weekly, deaths_weekly)], 
               by.x='region', by.y='countriesAndTerritories', all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE)
```

```{r eucase, fig.height=12, fig.width=9}
p1 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases_weekly)) +
  geom_polygon(colour='transparent', size=0.01) +
  coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) +
  scale_fill_gradient(low='white', high=case_col, na.value='grey50') +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank())

p2 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=cases_weekly / popData2019 * popnorm)) +
  geom_polygon(colour='transparent', size=0.01) +
  coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) +
  scale_fill_gradient(low='white', high=case_col, na.value='grey50', name=paste('cases_weekly\nper', popnorm)) +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank())

print( p1 / p2 )

ggsave(file.path(dirpath,'europe_cases.png'), plot = p1 / p2, device = png(), 
       scale = 1, width = 10, height = 12, units = "cm", dpi = 300, limitsize = TRUE)
```

```{r eudeath, fig.height=12, fig.width=9}
p3 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths_weekly)) +
  geom_polygon(colour='transparent', size=0.01) +
  coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) +
  scale_fill_gradient(low='white', high=death_col, na.value='grey50') +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank())

p4 <- ggplot(subDT, 
       aes(x=long, y=lat, group=group, fill=deaths_weekly / popData2019 * popnorm)) +
  geom_polygon(colour='transparent', size=0.01) +
  coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) +
  scale_fill_gradient(low='white', high=death_col, na.value='grey50', name=paste('deaths_weekly\nper', popnorm)) +
  theme(panel.background=element_rect(fill=seablue),
        panel.grid=element_blank())

print( p3 / p4 )

ggsave(file.path(dirpath,'europe_deaths.png'), plot = p3 / p4, device = png(),
       scale = 1, width = 10, height = 12, units = "cm", dpi = 300, limitsize = TRUE)
```

### EU

```{r eu, fig.height=15, fig.width=15}
p1 <- ggplot(eut,
       aes(x=long, y=lat, group=group,
           fill=subnational_cases_7)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient(low='white', high=case_col, name='Weekly Cases') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue))

p2 <- ggplot(eut,
       aes(x=long, y=lat, group=group,
           fill=subnational_cases_7 / subnational_population * 1e5)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient(low='white', high=case_col, name='Weekly Cases\nper 100K') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='right',
        panel.background=element_rect(fill=seablue))

p3 <- ggplot(eut,
       aes(x=long, y=lat, group=group,
           fill=(subnational_cases_14 - 2 * subnational_cases_7) / subnational_population * 1e5)) +
  geom_polygon(colour='transparent') +
  scale_fill_gradient2(low='magenta', mid='white', high='darkorange', midpoint=0, name='Weekly difference\nper 100K') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='right',
        panel.background=element_rect(fill=seablue))

p4 <- ggplot(eut,
       aes(x=long, y=lat, group=group,
           fill=colour)) +
  geom_polygon(colour='transparent') +
  scale_fill_identity() +
  labs(x=NULL, y=NULL, title='Traffic light code') +
  theme_void() +
  theme(legend.position='left',
        panel.background=element_rect(fill=seablue))

print( (p4 | p3) / (p1 | p2) )

ggsave(((p4|p3)/(p1|p2)), file=file.path(dirpath, 'Austria_sub.png'), device='png')
```


### Zoom on selected countries

```{r austria, fig.height=5, fig.width=10}
subDT <- merge(eu2t[CNTR_CODE=='AT',],
             movement[country=='Austria',],
             by.x='NUTS_ID', by.y='geo_id_final', all.x=TRUE)
setorder(subDT, NUTS_ID, order)

p1 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=subnational_cases_7)) +
  geom_polygon(colour='black') +
  scale_fill_gradient(low='white', high=case_col, name='Weekly Cases') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='left')

p2 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=subnational_cases_7 / subnational_population * 1e5)) +
  geom_polygon(colour='black') +
  scale_fill_gradient(low='white', high=case_col, name='Weekly Cases\nper 100K') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='right')

p3 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=(subnational_cases_14 - 2 * subnational_cases_7) / subnational_population * 1e5)) +
  geom_polygon(colour='black') +
  scale_fill_gradient2(low='magenta', mid='white', high='darkorange', midpoint=0, name='Weekly difference\nper 100K') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='right')

p4 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=colour)) +
  geom_polygon(colour='black') +
  scale_fill_identity() +
  labs(x=NULL, y=NULL, title='Traffic light code') +
  theme_void() +
  theme(legend.position='left')

print( (p4 | p3) / (p1 | p2) )

ggsave(((p4|p3)/(p1|p2)), file=file.path(dirpath, 'Austria_sub.png'), device='png')
```

```{r greece, fig.height=8, fig.width=10}
subDT <- merge(eu2t[CNTR_CODE=='EL',],
             movement[country=='Greece',],
             by.x='NUTS_ID', by.y='geo_id_final', all.x=TRUE)
setorder(subDT, NUTS_ID, order)

p1 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=subnational_cases_7)) +
  geom_polygon(colour='black') +
  scale_fill_gradient(low='white', high=case_col, name='Weekly Cases') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='left')

p2 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=subnational_cases_7 / subnational_population * 1e5)) +
  geom_polygon(colour='black') +
  scale_fill_gradient(low='white', high=case_col, name='Weekly Cases\nper 100K') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='right')

p3 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=(subnational_cases_14 - 2 * subnational_cases_7) / subnational_population * 1e5)) +
  geom_polygon(colour='black') +
  scale_fill_gradient2(low='magenta', mid='white', high='darkorange', midpoint=0, name='Weekly difference\nper 100K') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='right')

p4 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=colour)) +
  geom_polygon(colour='black') +
  scale_fill_identity() +
  labs(x=NULL, y=NULL, title='Traffic light code') +
  theme_void() +
  theme(legend.position='left')

print( (p4 | p3) / (p1 | p2) )

ggsave(((p4|p3)/(p1|p2)), file=file.path(dirpath, 'Greece_sub.png'), device='png')
```

```{r italy, fig.height=11, fig.width=10}
subDT <- merge(eu2t[CNTR_CODE=='IT',],
             movement[country=='Italy',],
             by.x='NUTS_ID', by.y='geo_id_final', all.x=TRUE)
setorder(subDT, NUTS_ID, order)

p1 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=subnational_cases_7)) +
  geom_polygon(colour='black') +
  scale_fill_gradient(low='white', high=case_col, name='Weekly Cases') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='left')

p2 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=subnational_cases_7 / subnational_population * 1e5)) +
  geom_polygon(colour='black') +
  scale_fill_gradient(low='white', high=case_col, name='Weekly Cases\nper 100K') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='right')

p3 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=(subnational_cases_14 - 2 * subnational_cases_7) / subnational_population * 1e5)) +
  geom_polygon(colour='black') +
  scale_fill_gradient2(low='magenta', mid='white', high='darkorange', midpoint=0, name='Weekly difference\nper 100K') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='right')

p4 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=colour)) +
  geom_polygon(colour='black') +
  scale_fill_identity() +
  labs(x=NULL, y=NULL, title='Traffic light code') +
  theme_void() +
  theme(legend.position='left')

print( (p4 | p3) / (p1 | p2) )

ggsave(((p4|p3)/(p1|p2)), file=file.path(dirpath, 'Italy_sub.png'), device='png')
```

```{r germany, fig.height=13, fig.width=10}
subDT <- merge(eu1t[CNTR_CODE=='DE', ],
             movement[country=='Germany', ],
             by.x='NUTS_ID', by.y='geo_id_final', all.x=TRUE)
setorder(subDT, NUTS_ID, order)

p1 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=subnational_cases_7)) +
  geom_polygon(colour='black') +
  scale_fill_gradient(low='white', high=case_col, name='Weekly Cases') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='left')

p2 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=subnational_cases_7 / subnational_population * 1e5)) +
  geom_polygon(colour='black') +
  scale_fill_gradient(low='white', high=case_col, name='Weekly Cases\nper 100K') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='right')

p3 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=(subnational_cases_14 - 2 * subnational_cases_7) / subnational_population * 1e5)) +
  geom_polygon(colour='black') +
  scale_fill_gradient2(low='magenta', mid='white', high='darkorange', midpoint=0, name='Weekly difference\nper 100K') +
  labs(x=NULL, y=NULL) +
  theme_void() +
  theme(legend.position='right')

p4 <- ggplot(subDT,
       aes(x=long, y=lat, group=group,
           fill=colour)) +
  geom_polygon(colour='black') +
  scale_fill_identity() +
  labs(x=NULL, y=NULL, title='Traffic light code') +
  theme_void() +
  theme(legend.position='left')

print( (p4 | p3) / (p1 | p2) )

ggsave(((p4|p3)/(p1|p2)), file=file.path(dirpath, 'Germany_sub.png'), device='png')
```


## Top 10s

### World's current worst

#### By cases

```{r wtopcase}
# Worse 10 (or more) by weekly cases
subDT <- casedist[dateRep==endday & !is.na(cases_weekly), 
                  .(countriesAndTerritories, dateRep, cases_weekly, population_normalized = cases_weekly / popData2019 * popnorm)] [order(cases_weekly, decreasing=TRUE), ]

n <- max(10, nrow(subDT[sapply(subDT$cases_weekly, 
                               function(x) { 
                                 all.equal(subDT$cases_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

#### By deaths

```{r wtopdeath}
# Worse 10 (or more) by weekly deaths
subDT <- casedist[dateRep==endday & !is.na(deaths_weekly), 
                  .(countriesAndTerritories, dateRep, deaths_weekly, population_normalized = deaths_weekly / popData2019 * popnorm)] [order(deaths_weekly, decreasing=TRUE), ]

n <- max(10, nrow(subDT[sapply(subDT$deaths_weekly, 
                               function(x) { 
                                 all.equal(subDT$deaths_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )

# Worse 10 (or more) by weekly deaths normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

### Europe's current worst

#### By cases

```{r eutopcase}
# Worse 10 (or more) by weekly cases
subDT <- casedist[dateRep==endday & !is.na(cases_weekly) & continentExp == 'Europe', 
                  .(countriesAndTerritories, dateRep, cases_weekly, population_normalized = cases_weekly / popData2019 * popnorm)] [order(cases_weekly, decreasing=TRUE), ]

n <- max(10, nrow(subDT[sapply(subDT$cases_weekly, 
                               function(x) { 
                                 all.equal(subDT$cases_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

#### By deaths

```{r eutopdeath}
# Worse 10 (or more) by weekly deaths
subDT <- casedist[dateRep==endday & !is.na(deaths_weekly) & continentExp == 'Europe', 
                  .(countriesAndTerritories, dateRep, deaths_weekly, population_normalized = deaths_weekly / popData2019 * popnorm)] [order(deaths_weekly, decreasing=TRUE), ]

n <- max(10, nrow(subDT[sapply(subDT$deaths_weekly, 
                               function(x) { 
                                 all.equal(subDT$deaths_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )

# Worse 10 (or more) by weekly deaths normalized
setorder(subDT, -population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

### Europe's current best

#### By cases

```{r eutopcase2}
# Worse 10 (or more) by weekly cases
subDT <- casedist[dateRep==endday & !is.na(cases_weekly) & continentExp == 'Europe', 
                  .(countriesAndTerritories, dateRep, cases_weekly, population_normalized = cases_weekly / popData2019 * popnorm)] [order(cases_weekly, decreasing=FALSE), ]

n <- max(10, nrow(subDT[sapply(subDT$cases_weekly, 
                               function(x) { 
                                 all.equal(subDT$cases_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))

print( head(subDT, n) )

# Worse 10 (or more) by weekly cases normalized
setorder(subDT, population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

#### By deaths

```{r eutopdeath2}
# Worse 10 (or more) by weekly deaths
subDT <- casedist[dateRep==endday & !is.na(deaths_weekly) & continentExp == 'Europe', 
                  .(countriesAndTerritories, dateRep, deaths_weekly, population_normalized = deaths_weekly / popData2019 * popnorm)] [order(deaths_weekly, decreasing=FALSE), ]

n <- max(10, nrow(subDT[sapply(subDT$deaths_weekly, 
                               function(x) { 
                                 all.equal(subDT$deaths_weekly[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )

# Worse 10 (or more) by weekly deaths normalized
setorder(subDT, population_normalized, na.last=TRUE)

n <- max(10, nrow(subDT[sapply(subDT$population_normalized, 
                               function(x) { 
                                 all.equal(subDT$population_normalized[min(10, nrow(subDT))], x)
                               }) == TRUE, ]))
print( head(subDT, n) )
```

## Countries of personal interest

```{r interest}
print( 
  casedist[dateRep==endday & countriesAndTerritories %in% family_countries,
           .(countriesAndTerritories, dateRep, year_week, cases_weekly, population_normalized = cases_weekly / popData2019 * popnorm)] )

print( 
  casedist[dateRep==endday & countriesAndTerritories %in% family_countries,
           .(countriesAndTerritories, dateRep, year_week, deaths_weekly, population_normalized = cases_weekly / popData2019 * popnorm)] )


# print( unique(
#   movement[country %in% family_countries & week==endweek, 
#            .(country, national_cases_7, national_positivity_rate)] ) )
# 
# print( 
#   movement[country %in% family_countries & week==endweek, 
#            .(country, region, subnational_rate_14)] )
```



# Progression

<!-- ## GIF Maps -->

<!-- ```{r pregif} -->
<!-- subDT <- merge(world_map[, .(region, long, lat, group, order)], -->
<!--                casedist[, .(countriesAndTerritories, popData2019, cases_weekly, deaths_weekly, dateRep)], -->
<!--                by.x='region', by.y='countriesAndTerritories', all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE) -->
<!-- ``` -->

<!-- ### World -->

<!-- ```{r gifw, fig.height=7, fig.width=12} -->
<!-- anim <- ggplot(subDT) + -->
<!--   geom_polygon(aes(x=long, y=lat, group=group, fill=cases_weekly / popData2019 * popnorm), -->
<!--                colour='black', size=0.01) + -->
<!--   transition_states(dateRep, transition_length = 0, state_length = 1, wrap=TRUE) + -->
<!--   scale_fill_gradient(low='white', high=case_col, na.value='grey50', name=paste('per', popnorm)) + -->
<!--   coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic -->
<!--   labs(title='Weekly cases: {closest_state}') + -->
<!--   theme(panel.background=element_rect(fill=seablue), -->
<!--         panel.grid=element_line(colour='white', size=0.1)) -->

<!-- gif <- animate(anim, duration=30, end_pause=15,  -->
<!--                 width=1200, height=700, renderer=gifski_renderer() ) -->

<!-- anim_save(file.path(dirpath,'world_cases.gif'), animation=gif) -->

<!-- gif -->
<!-- ``` -->

<!-- ```{r gifw2, fig.height=7, fig.width=12} -->
<!-- anim <- ggplot(subDT) + -->
<!--   geom_polygon(aes(x=long, y=lat, group=group, fill=deaths_weekly / popData2019 * popnorm), -->
<!--                colour='black', size=0.01) + -->
<!--   transition_states(dateRep, transition_length = 0, state_length = 1, wrap=TRUE) + -->
<!--   scale_fill_gradient(low='white', high=death_col, na.value='grey50', name=paste('per', popnorm)) + -->
<!--   coord_cartesian(ylim=c(-60, 80), xlim=c(-180,180)) + # Crop giant Antarctica and empty Arctic -->
<!--   labs(title='Weekly deaths: {closest_state}') + -->
<!--   theme(panel.background=element_rect(fill=seablue), -->
<!--         panel.grid=element_line(colour='white', size=0.1)) -->

<!-- gif <- animate(anim, duration=30, end_pause=15,  -->
<!--                 width=1200, height=700, renderer=gifski_renderer() ) -->

<!-- anim_save(file.path(dirpath,'world_deaths.gif'), animation=gif) -->

<!-- gif -->
<!-- ``` -->

<!-- ### Europe -->

<!-- ```{r gife, fig.height=7, fig.width=10} -->
<!-- anim <- ggplot(subDT) + -->
<!--   geom_polygon(aes(x=long, y=lat, group=group, fill=cases_weekly / popData2019 * popnorm), -->
<!--                colour='black', size=0.01) + -->
<!--   transition_states(dateRep, transition_length = 0, state_length = 1, wrap=TRUE) + -->
<!--   scale_fill_gradient(low='white', high=case_col, na.value='grey50', name=paste('per', popnorm)) + -->
<!--   coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) + -->
<!--   labs(title='Weekly cases: {closest_state}') + -->
<!--   theme(panel.background=element_rect(fill=seablue), -->
<!--         panel.grid=element_line(colour='white', size=0.1)) -->

<!-- gif <- animate(anim, duration=30, end_pause=15,  -->
<!--                 width=1000, height=700, renderer=gifski_renderer() ) -->

<!-- anim_save(file.path(dirpath,'europe_cases.gif'), animation=gif) -->

<!-- gif -->
<!-- ``` -->

<!-- ```{r gife2, fig.height=7, fig.width=10} -->
<!-- anim <- ggplot(subDT) + -->
<!--   geom_polygon(aes(x=long, y=lat, group=group, fill=deaths_weekly / popData2019 * popnorm), -->
<!--                colour='black', size=0.01) + -->
<!--   transition_states(dateRep, transition_length = 0, state_length = 1, wrap=TRUE) + -->
<!--   scale_fill_gradient(low='white', high=death_col, na.value='grey50', name=paste('per', popnorm)) + -->
<!--   coord_cartesian(ylim=c(35, 70), xlim=c(-27,50)) + -->
<!--   labs(title='Weekly deaths: {closest_state}') + -->
<!--   theme(panel.background=element_rect(fill=seablue), -->
<!--         panel.grid=element_line(colour='white', size=0.1)) -->

<!-- gif <- animate(anim, duration=30, end_pause=15,  -->
<!--                 width=1000, height=700, renderer=gifski_renderer() ) -->

<!-- anim_save(file.path(dirpath,'europe_deaths.gif'), animation=gif) -->

<!-- gif -->
<!-- ``` -->


## Plots

```{r cumulative}
# Cumulative totals.
# In exponential growth, new cases are proportional to the total cases.
setorder(casedist, year_week, dateRep, countriesAndTerritories)
casedist[, total_cases := cumsum(cases_weekly), by='countriesAndTerritories']
casedist[, total_deaths := cumsum(deaths_weekly), by='countriesAndTerritories']
# Need 2 country variables to simultaneously differentially display some stuff and all stuff.
casedist[, country := countriesAndTerritories]
```

### Growth in selected countries

New events relative to total events. In exponential growth, the new events are proportional to the total events.

```{r expo, fig.width=10, fig.height=15}
# New vs Total
expo <- function(selcnt=family_countries){
  # Prime a dummy table to graft things onto
  pileup <- data.table(cases_weekly=NA_integer_, deaths_weekly=NA_integer_,
                       countriesAndTerritories=NA_character_,
                       total_cases=NA_integer_, total_deaths=NA_integer_,
                       country=NA_integer_)
  # Graft
  for (cnt in selcnt){
    clonecd <- copy(casedist[, .(cases_weekly, deaths_weekly, countriesAndTerritories,
                                 total_cases, total_deaths, country)])
    clonecd[, country := cnt]
    pileup <- rbind(pileup, clonecd)
  }
  # Lose the primer
  pileup <- pileup[2:nrow(pileup),]
  # Melt cases and deaths
  pileup <- melt(pileup, id.vars=c('countriesAndTerritories', 'country'),
                 measure=list(c('cases_weekly', 'deaths_weekly'), 
                    c('total_cases', 'total_deaths')),
                 value.name=c('Weekly', 'Total'))
  subdist <- melt(casedist, id.vars=c('countriesAndTerritories', 'country'),
                  measure=list(c('cases_weekly', 'deaths_weekly'), 
                    c('total_cases', 'total_deaths')),
                  value.name=c('Weekly', 'Total'))
  
  pileup[variable==1, variable := 'Cases']
  pileup[variable==2, variable := 'Deaths']
  pileup[, variable := factor(variable, levels=c('Cases', 'Deaths'), ordered=TRUE)]
  subdist[variable==1, variable := 'Cases']
  subdist[variable==2, variable := 'Deaths']
  subdist[, variable := factor(variable, levels=c('Cases', 'Deaths'), ordered=TRUE)]
  
  # Plot
  p1 <- ggplot(pileup, 
       aes(x=Total, y=Weekly,
           group=countriesAndTerritories)) +
    facet_grid(country ~ variable) +
    geom_line(colour='black', size=0.5, alpha=0.1) +
    scale_x_log10() +
    scale_y_log10() +
    geom_line(data=subdist[countriesAndTerritories %in% selcnt,], 
              aes(colour=variable), size=1, alpha=1) +
    coord_cartesian(ylim=c(1,NA), xlim=c(1,NA)) +
    scale_colour_manual(values=c(case_col, death_col), guide='none') +
    annotation_logticks(base=10, sides='lbrt') +
    theme_bw()
    
  return( p1 )
}
  
for (x in list(family_countries, 
              c(homecountry, neighbour_countries), 
              c(homecountry, other_countries),
              c(homecountry, holiday_options))) {
  p <- expo(x)
  print( p )
  ggsave(p, file=file.path(dirpath,paste(paste(x, collapse='-'), 'expo.png', sep='_')), device='png')
}
```

### Waves in selected countries

The previous does not take recovery into account. Only active infections create new cases. Using the cumulative cases in a smaller 4-week rolling window as approximation of active cases.

```{r wave, fig.width=10, fig.height=15}
# Use 4-week rolling sum as an approximation for active total.
casedist[, monthly_cases := frollsum(cases_weekly, n=4), by='countriesAndTerritories']
casedist[, monthly_deaths := frollsum(deaths_weekly, n=4), by='countriesAndTerritories']

# New vs Monthly
wave <- function(selcnt=family_countries){
  # No melty business here. Cases and deaths need completely different Y scales.
  p1 <- ggplot(casedist[countriesAndTerritories %in% selcnt,],
           aes(x=monthly_cases / popData2019 * popnorm, 
               y=cases_weekly / popData2019 * popnorm,
               colour=dateRep, group=countriesAndTerritories)) +
    facet_grid(country ~ ., scales='fixed') +
    geom_path(size=1) +
    scale_colour_gradientn(colours=c('black','black',case_col), guide='none') +
    coord_cartesian(xlim=c(0,NA), ylim=c(0,NA)) +
    labs(title='Waves', x=paste('Monthly cases per', popnorm), y=paste('Weekly cases per', popnorm)) +
    theme_bw() +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))
  
  p2 <- ggplot(casedist[countriesAndTerritories %in% selcnt,],
           aes(x=monthly_deaths / popData2019 * popnorm, 
               y=deaths_weekly / popData2019 * popnorm,
               colour=dateRep, group=countriesAndTerritories)) +
    facet_grid(country ~ ., scales='fixed') +
    geom_path(size=1) +
    scale_colour_gradientn(colours=c('black','black',death_col), guide='none') +
    coord_cartesian(xlim=c(0,NA), ylim=c(0,NA)) +
    labs(x=paste('Monthly deaths per', popnorm), y=paste('Weekly deaths per', popnorm)) +
    theme_bw() +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))
  
  return( p1 | p2 )
}

for (x in list(family_countries, 
              c(homecountry, neighbour_countries), 
              c(homecountry, other_countries),
              c(homecountry, holiday_options))) {
  p <- wave(x)
  print( p )
  ggsave(p, file=file.path(dirpath,paste(paste(x, collapse='-'), 'wave.png', sep='_')), device='png')
}
```

### Timeline in selected countries

A conventional view as function of time.

```{r time, fig.width=10, fig.height=15}
tline <- function(selcnt=family_countries){
  p1 <- ggplot(casedist[countriesAndTerritories %in% selcnt,],
           aes(x=dateRep, y=cases_weekly / popData2019 * popnorm,
               colour=dateRep, group=countriesAndTerritories)) +
    facet_grid(country ~ ., scales='fixed') +
    geom_path(size=1) +
    # scale_colour_manual(values=c(case_col, death_col), guide='none') +
    scale_colour_gradientn(colours=c('black','black',case_col), guide='none') +
    coord_cartesian(xlim=c(min(casedist$dateRep),max(casedist$dateRep)), ylim=c(0,NA)) +
    labs(title='Timeline', x=NULL, y=paste('Weekly cases per', popnorm)) +
    theme_bw() +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))
  
  
  p2 <- ggplot(casedist[countriesAndTerritories %in% selcnt,],
           aes(x=dateRep, y=deaths_weekly / popData2019 * popnorm,
               colour=dateRep, group=countriesAndTerritories)) +
    facet_grid(country ~ ., scales='fixed') +
    geom_path(size=1) +
    # scale_colour_manual(values=c(case_col, death_col), guide='none') +
    scale_colour_gradientn(colours=c('black','black',death_col), guide='none') +
    coord_cartesian(xlim=c(min(casedist$dateRep),max(casedist$dateRep)), ylim=c(0,NA)) +
    labs(x=NULL, y=paste('Weekly deaths per', popnorm)) +
    theme_bw() +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))
  
  return( p1 | p2 )  
}

for (x in list(family_countries, 
              c(homecountry, neighbour_countries), 
              c(homecountry, other_countries),
              c(homecountry, holiday_options))) {
  p <- tline(x)
  print( p )
  ggsave(p, file=file.path(dirpath, paste(paste(x, collapse='-'), 'tline.png', sep='_')), device='png')
}
```

