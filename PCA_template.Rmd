---
title: "PCA"
author: "Kimon Froussios"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: yes
---

\VignetteEngine{knitr::knitr}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r message=FALSE, warning=FALSE}
library(data.table)
library(ggplot2)
library(plotly)
library(matrixStats)
library(ggExtra)
library(htmltools)
library(cluster)

theme_set(theme_bw())

# Calculate PCA and plots
do_pca <- function(counts, covars, ntop=50L, center=TRUE, scale=TRUE){
  # Convert table to matrix
  countsmat <- as.matrix(counts[, 2:length(counts)])
  rownames(countsmat) <- counts$Geneid
  
  # Gene variances
  genevar <- data.table(name = rownames(countsmat),
                        Mean = rowMeans(countsmat),
                        StDev = rowVars(countsmat) )
  
  genevar[, istop := name %in% head(genevar[order(genevar$StDev, decreasing = TRUE), name], n=ntop)]
  
  pvar1 <- ggMarginal(ggplot(genevar) +
      geom_point(aes(x=Mean, y=StDev, label=name, colour=istop), shape=16, size=0.8, alpha=0.5) +
      labs(x="Mean", y="Standard Deviation") +
      scale_x_log10() +
      scale_colour_manual(values=c("black", "purple")) +
      scale_y_log10() +
      ggtitle("All features across all observations") +
      theme(legend.position = "none"),
    type = "histogram")
  
  genevar <- genevar[(istop),]
  setorder(genevar, -StDev)
  
  pvar2 <- ggplot(genevar) +
      geom_point(aes(x=Mean, y=StDev, label=name), shape=16, size=0.8, alpha=0.5, colour="purple") +
      labs(x="Mean", y="Standard Deviation") +
      scale_x_log10() +
      scale_y_log10() +
      ggtitle(paste("Top", ntop, "features"))
  
  # Correlation of the samples for the selected features only
  sel <- rownames(countsmat) %in% genevar$name
  genec <- cor(countsmat[sel, ])
  hcfit <- hclust(dist(t(genec)))
  rn <- rownames(genec)
  genec <- as.data.table(genec)
  genec[, observation1 := rn]
  genec <- melt(genec, id.vars = "observation1", value.name = "correlation", variable.name = "observation2")
  genec[, observation1 := factor(observation1, ordered=TRUE, 
                                 levels=rn[hcfit$order]) ]
  genec[, observation2 := factor(observation2, ordered=TRUE, 
                                 levels=rn[hcfit$order]) ]
  
  pcor1 <- ggplot(genec, aes(x=observation1, y=observation2, fill=correlation, label=correlation)) +
    geom_tile() +
    # geom_text(colour="white") +
    # scale_x_discrete(position="top") +
    scale_fill_gradientn(limits=c(-1, 1), colors=c("steelblue2", "blue", "darkblue", "black", "darkred", "red", "orange") ) +
    labs(x='', y='') +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5))
  
  # Rotate counts so genes are variables and samples are observations
  countsmat <- t(countsmat)
  
  # Correlation of the selected features
  genec <- cor(countsmat[, sel])
  hcfit <- hclust(dist(t(genec)))
  rn <- rownames(genec)
  genec <- as.data.table(genec)
  genec[, observation1 := rn]
  genec <- melt(genec, id.vars = "observation1", value.name = "correlation", variable.name = "observation2")
  genec[, observation1 := factor(observation1, ordered=TRUE, 
                                 levels=rn[hcfit$order]) ]
  genec[, observation2 := factor(observation2, ordered=TRUE, 
                                 levels=rn[hcfit$order]) ]
  
  pcor2 <- ggplot(genec, aes(x=observation1, y=observation2, fill=correlation, label=correlation)) +
    geom_tile() +
    # geom_text(colour="white") +
    # scale_x_discrete(position="top") +
    scale_fill_gradientn(limits=c(-1, 1), colors=c("steelblue2", "blue", "darkblue", "black", "darkred", "red", "orange") ) +
    labs(x='', y='') +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5))
  if (ntop >50) {
    pcor2 <- pcor2 + theme(axis.text.x = element_blank(), axis.text.y = element_blank())
  }
  
  # Add covariates info
  counts <- cbind(covars, as.data.frame(countsmat))
  rownames(counts) <- rownames(countsmat)

  # Calculate principal components (after getting rid of zero-variance genes that can't be standardized)
  countsmat <- countsmat[, genevar$name]
  nonconstant <- which(apply(countsmat, 2, var)!=0)
  countsmat <- countsmat[, nonconstant]
  
  pca <- prcomp(countsmat, center = center, scale. = scale)
  srn <- sqrt(nrow(countsmat) - 1)
  pc <- sweep(pca$x, 2, 1 / (pca$sdev * srn), FUN = '*')
  pc <- cbind(pc, data.frame(name = rownames(pc)))
  pc <- merge(pc, covars, by.x = "name", by.y="sample", all = TRUE)
  
  # Coefficient names
  ig <- names(covars)
  ig <- ig[! ig %in% c('sample', 'Sample', 'name', 'Name', 'sizeFactor')]

  
  pcaimp <- as.data.table(cbind(as.data.frame(t(summary(pca)$importance)), 
                  data.frame(PC = 1:length(colnames(pca$x)))))
  pcaimp <- melt(pcaimp, variable.name = "type", value.name = "Proportion", id.vars = c("PC", "Standard deviation"))
  
  pcmax=15
  pimp <- ggplot(pcaimp[(PC<pcmax),], aes(x=PC, y=Proportion)) +
    facet_grid(type ~ ., scales="free_y") +
    geom_bar(aes(fill=type), stat="identity", width=0.6) +
    geom_line(aes(colour=type)) +
    scale_fill_manual(values = c("grey50", "transparent")) +
    scale_colour_manual(values = c("transparent", "grey25")) +
    scale_x_continuous(breaks = seq(1, pcmax, 2)) +
    labs(title = "PCA Screeplot", x = "Principal Component") +
    theme(axis.title.y = element_blank(),
          legend.position = "none")

  # Plot first 3 PCs in 2D pairs.
  # Highlight one variable at a time.
  l1 <- lapply(ig, function(varname) { 
    return( 
      ggplot(pc, aes_string(x="PC1", y="PC2", label="name", colour=varname)) +
        geom_point(shape=16) +
        coord_fixed()
    )})
  # do.call(grid.arrange, c(l1, ncol=2))

  l2 <- lapply(ig, function(varname) { 
    return( 
      ggplot(pc, aes_string(x="PC1", y="PC3", label="name", colour=varname)) +
        geom_point(shape=16) +
        coord_fixed()
    )})
  # do.call(grid.arrange, c(l2, ncol=2))

  l3 <- lapply(ig, function(varname) { 
    return( 
      ggplot(pc, aes_string(x="PC2", y="PC3", label="name", colour=varname)) +
        geom_point(shape=16) +
        coord_fixed()
    )})
  # do.call(grid.arrange, c(l3, ncol=2))
  
  return(list(pvar1=pvar1, pvar2=pvar2, genevar=genevar, pcor1=pcor1, pcor2=pcor2, nPC=sum(grepl("PC\\d+", names(pc), perl=TRUE)), pimp=pimp, pc_1_2=l1, pc_1_3=l2, pc_2_3=l3))
}
```

Input

```{r input}
covars <- fread('/Volumes/groups/zuber/zubarchive/USERS/Kimon/markus/M9179_quantseq/description/covars.txt')
# Gene and sg are mutually redundant info
covars <- covars[, names(covars) != "sg", with=FALSE]
setkey(covars, sample)

xref <- fread("/Volumes/groups/zuber/zubarchive/USERS/Kimon/markus/M9179_quantseq/aux/xref_mm_genes.txt")
setkey(xref, ensembl_gene_id)

counts <- fread('/Volumes/groups/zuber/zubarchive/USERS/Kimon/markus/M9179_quantseq/process/counts/all_counts_named.tsv')
# g <- data.table(eid = counts$Geneid,
#                 name = xref[counts$Geneid, external_gene_name] )
# g[is.na(name), name := eid]
# counts[, Geneid := g$name]
setkey(counts, Geneid)

# fwrite(counts, file='/Volumes/groups/zuber/zubarchive/USERS/Kimon/markus/M9179_quantseq/process/counts/all_counts_renamed.tsv', sep="\t")
```

# PCA all

## Feature selection

### Variances

```{r}
# Variance VS Mean
res <- do_pca(counts, covars)
print(res[["pvar1"]])
ggplotly(res[["pvar2"]])
```

### Selected features

```{r}
# Top variance genes
print(res[["genevar"]]$name)
```

## Correlations

### among samples

```{r fig.width=15, fig.height=15}
print(res[["pcor1"]])
```

### among selected features

```{r fig.width=10, fig.height=10}
print(res[["pcor2"]])
```

## PCA

```{r}
# Scree
cat(paste(res[["nPC"]], "principal componenets."))
print(res[["pimp"]])
```

### PC1 + PC2

```{r}
htmltools::tagList(lapply(res[["pc_1_2"]], function(x) { ggplotly(x) }))
```

### PC1 + PC3

```{r}
htmltools::tagList(lapply(res[["pc_1_3"]], function(x) { ggplotly(x) }))
```

### PC2 + PC3

```{r}
htmltools::tagList(lapply(res[["pc_2_3"]], function(x) { ggplotly(x) }))
```

