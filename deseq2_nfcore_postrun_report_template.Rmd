---
title: "Differential Abundance Quick View"
author: "Kimon Froussios"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float:
      collapsed: false
params:
  comparison: condition_Control.time_W6_vs_W3                # name of a specific comparison for this report
  da_path: /SCRATCH/PP2023011_SLC13A5/tesslinz_diffex                           # output dir of nf-core/differentialabundance
  counts: /SCRATCH/PP2023011_SLC13A5/tesslinz.salmon.merged.gene_counts.tsv      # file of raw counts
  tpm: /SCRATCH/PP2023011_SLC13A5/tesslinz.salmon.merged.gene_tpm.tsv      # file of tpm counts
  covars: /SCRATCH/PP2023011_SLC13A5/samplesheet_tesslinz.differentialabundance.csv # samplesheet file for nf-core/differentialabundance
  contrasts: /SCRATCH/PP2023011_SLC13A5/contrasts_tesslinz.differentialabundance.csv # contrasts file for nf-core/differentialabundance
  gsea_path: /SCRATCH/REFERENCES/msigdb_v2023.2.Hs_GMTs                         # locatinon o GMT files used for GSEA
  highlight_n: 50       # number of genes to highlight
  min_count: 10
  min_tpm: 5
  min_lfc: 0.5
  max_q: 0.05
  genelist : null                                                                   # file with custom gene list to highlight instead of DE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, bitmapType='cairo-png')
```

# Setup

```{r libraries}
setwd(params$da_path)

library(data.table)
library(ggplot2)
library(patchwork)
library(ggrepel)
library(ggdendro)
library(DT)
library(DESeq2)
# library(plotly)
# library(htmltools)
library(stringr)

# ggplot2 base theme
theme_set(theme_bw())

# data.table::setDTthreads(1L)

options(scipen=200)
```

```{r load}

# munge_DE_tables <- function(dds = readRDS(file.path(params$da_path, 'other', 'deseq2', paste0(params$comparison, '.dds.rld.rds'))),
#                             counts = fread(params$counts),
#                             tpm = fread(params$tpm)) {
#   
# }
  
  
# DE
dds <- readRDS(file.path(params$da_path, 'other', 'deseq2', paste0(params$comparison, '.dds.rld.rds')))

# Metadata
covars <- as.data.table(colData(dds))



# Contrast
stopifnot(str_detect(params$comparison, '\\w+_\\w+_vs_\\w+'))
contrast <- str_split(str_extract(params$comparison, '\\w+_\\w+_vs_\\w+'), '_')[[1]]
mainvar <- contrast[1]
vartreat <- contrast[2]
varref <- contrast[4]


# Make generic name for coding ease
covars[, mainvar := covars[[mainvar]]]
covars[mainvar == varref, mainvar := 'reference']
covars[mainvar == vartreat, mainvar := 'target']

# Relevant samples
subsamples <- covars$sample
if(str_detect(params$comparison, '\\w+_\\w+\\.\\w+_\\w+_vs_\\w+')) {
  selection <- str_split(str_extract(params$comparison, '^\\w+_\\w+'), '_')[[1]]
  selvar <- selection[1]
  selval <- selection[2]
  subsamples <- covars$sample[covars[[selvar]] == selval]
}
covars <- covars[sample %in% subsamples, ]
# Excluded due to sequencing QC or other external reasons
if ('use' %in% names(covars) && is.logical(covars$use)) {
  subsamples <- covars[(use), sample]
}

# FC
deseq <- fread(file.path(params$da_path, 'tables', 'differential', paste0(params$comparison, '.deseq2.results.tsv')))



shrink <- lfcShrink(dds, type ='ashr', contrast = c(mainvar, vartreat, varref),      # apeglm doesn't like this format of contrast specification
                    res = results(dds, contrast = c(mainvar, vartreat, varref), alpha = params$max_q, lfcThreshold = 0, independentFiltering = TRUE))
shrink <- data.table(gene_id = rownames(shrink), shrunkLFC = shrink$log2FoldChange)
deseq <- merge(deseq, shrink, by = 'gene_id')
fwrite(deseq, file = file.path(params$da_path, 'tables', 'differential', paste0(params$comparison, '.deseq2.results.csv')), sep=',', col.names = TRUE) # don't want to overwrite, it would complicate reruns

# DE filters
deseq[, fltr_fdr_pass := padj < params$max_q] # this also covers NA (ie genes not tested due to failing deseq filtering)
deseq[, fltr_lfc_pass := abs(log2FoldChange) >= params$min_lfc]
deseq[, fltr_de_pass := fltr_fdr_pass & fltr_lfc_pass]
## Home-brewed selection of top hits to highlight, by euclidean distance from origin.
# It mostly works OK, but the selection should not be taken as gospel.
# Down-weight mlog10p for a more balanced selection not dominated by p value.
pbias <- 0.75    # bias the point selection to slightly prioritize pvalue over fold-change (< 1) or vice verse (> 1)
deseq[, mlog10p := -log10(padj)]
deseq[, absl2fc := abs(shrunkLFC)]
ppen <- max(deseq$mlog10p[is.finite(deseq$mlog10p)]) / max(deseq$absl2fc[is.finite(deseq$absl2fc)]) * pbias     # scaling factor determined by axes ranges
deseq[, radius := sqrt((mlog10p / ppen) ^ 2 + absl2fc ^ 2)]
deseq[, rank := rank(-radius, ties.method = 'average', na.last = TRUE)]
deseq[, absl2fc := NULL]
deseq[, mlog10p := NULL]

# Abundances
counts <- fread(params$counts)
tpm <- fread(params$tpm)
vst <- fread(file.path(params$da_path, 'tables', 'processed_abundance', 'all.vst.tsv'))
normcounts <- fread(file.path(params$da_path, 'tables', 'processed_abundance', 'all.normalised_counts.tsv'))
# Big table of counts of relevant samples
DTc <- melt(counts[, names(counts) %in% c('gene_id', 'gene_name', subsamples) , with = FALSE], 
            id.vars = c('gene_id', 'gene_name'), variable.name = 'sample', value.name = 'raw')
setkey(DTc, gene_id)
DTt  <- melt(tpm[, names(tpm) %in% c('gene_id', subsamples) , with = FALSE], 
            id.vars = c('gene_id'), variable.name = 'sample', value.name = 'tpm')
setkey(DTt, gene_id)
DTn <- melt(normcounts[, names(normcounts) %in% c('gene_id', subsamples) , with = FALSE], 
            id.vars = c('gene_id'), variable.name = 'sample', value.name = 'normalised')
setkey(DTn, gene_id)
DTv <- melt(vst[, names(vst) %in% c('gene_id', subsamples) , with = FALSE], 
            id.vars = c('gene_id'), variable.name = 'sample', value.name = 'vst')
setkey(DTv, gene_id)
DT <- Reduce(function(x, y){ merge(x, y, by = c('gene_id', 'sample'), all = TRUE)}, 
             list(DTc, DTt, DTn, DTv) )
DT <- melt(DT, id.vars = c('gene_id', 'gene_name', 'sample'), variable.name = 'count_type', value.name = 'abundance')

rm(DTc, DTt, DTn, DTv)

# Add DE
DT <- merge(DT, deseq, by = 'gene_id', all.x = TRUE)
# Add sample metadata
DT <- merge(DT, covars, by = 'sample', all.x = TRUE)

rm(deseq)

## Abundance filters
DT <- DT[count_type == 'raw' & mainvar == 'reference', condGeneMean := mean(.SD$abundance), by = gene_id]
DT <- DT[count_type == 'raw' & mainvar == 'target', condGeneMean := mean(.SD$abundance), by = gene_id]
DT <- DT[count_type == 'tpm' & mainvar == 'reference', condGeneMean := mean(.SD$abundance), by = gene_id]
DT <- DT[count_type == 'tpm' & mainvar == 'target', condGeneMean := mean(.SD$abundance), by = gene_id]
DT <- DT[count_type == 'normalised' & mainvar == 'reference', condGeneMean := mean(.SD$abundance), by = gene_id]
DT <- DT[count_type == 'normalised' & mainvar == 'target', condGeneMean := mean(.SD$abundance), by = gene_id]
DT <- DT[count_type == 'vst' & mainvar == 'reference', condGeneMean := mean(.SD$abundance), by = gene_id]
DT <- DT[count_type == 'vst' & mainvar == 'target', condGeneMean := mean(.SD$abundance), by = gene_id]

DT <- DT[count_type == 'raw', fltr_geneMean_pass := condGeneMean >= params$min_count]        # separately for each condition and count type
DT <- DT[count_type == 'tpm', fltr_geneMean_pass := condGeneMean >= params$min_tpm]
DT <- DT[, fltr_abund_pass := any(.SD[count_type == 'raw', fltr_geneMean_pass]) & any(.SD[count_type == 'tpm', fltr_geneMean_pass]), by = gene_id]  # aggregate: either condition, for both count types

# Eliminate NAs in booleans
DT[is.na(fltr_fdr_pass), fltr_fdr_pass := FALSE]                                # Genes that weren't tested due to failing deseq2 abundance filter
DT[is.na(fltr_lfc_pass), fltr_lfc_pass := FALSE]                                # 
DT[is.na(fltr_de_pass), fltr_de_pass := FALSE]                                  # still the same genes as above

# Master filter
DT[, fltr_pass := fltr_abund_pass & fltr_de_pass]

# Add highlight selection
if (!is.null(params$genelist)) {
  markgenes <- fread(params$genelist)[[1]]
  warning('Highlighting a custom list of genes. The quoted selection thresholds do not apply!')
} else {
  setorder(DT, rank)
  markgenes <- head(unique(DT[(fltr_pass), gene_id]), params$highlight_n)
  if (length(markgenes) <= 1) {                                                                       # if there isn't much to show
    markgenes <- head(unique(DT[, gene_id]), params$highlight_n)         # add some context of the nearest misses
  }
}
DT[, mark := gene_id %in% markgenes] 

# Fix order, for plot facets 
DT[, count_type := factor(count_type, levels = c('raw', 'tpm', 'normalised', 'vst'), ordered = TRUE)]
setkey(DT, gene_id, count_type, mainvar, sample)

# GSEA
gsea_categories <- dir(file.path(params$da_path, 'tables', 'gsea', params$comparison))
gsea_dirs <- file.path(params$da_path, 'tables', 'gsea', params$comparison, gsea_categories)
gsea_refs <- file.path(params$gsea_path, paste0(gsea_categories, '.gmt'))
```



# Contrast and Variables

```{r name}
cat('\n###\nContrast name:\n\n', params$comparison, '\n')

cat('\n###\nMetadata of the relevant samples:\n')
datatable(covars[sample %in% subsamples,], options = list(pageLength = min(25, nrow(covars))))
```



# Differential abundance

## FC & significance

`fltr_pass` represents genes that meet all of the criteria: FDR < `r params$max_q` , abs(L2FC) > `r params$min_lfc`, mean raw count in at least one condition > `r params$min_count`, and mean TPM in at least one condition > `r params$min_tpm`.

```{r volcano, fig.height=15, fig.width=15}
volcXY <- unique(DT[, .(gene_id, gene_name, padj, log2FoldChange, shrunkLFC, fltr_abund_pass, fltr_de_pass, fltr_pass, mark)])
volcXY[, upregulated := log2FoldChange > 0]
volcXY[log2FoldChange == 0, upregulated := NA] # edge case

desummary <- as.data.table(table(volcXY[, .(fltr_pass, upregulated)]))
desummary[as.logical(upregulated), DE := 'up']
desummary[!as.logical(upregulated), DE := 'down']
desummary[, upregulated := NULL]
setnames(desummary, c('fltr_pass', 'N_genes', 'Diff'))
setorder(desummary, fltr_pass)

print(desummary)

p_volcano <- ggplot(volcXY, aes(x = log2FoldChange, y = -log10(padj), colour = fltr_pass, label = gene_name)) +
  geom_point(data = volcXY[(!fltr_pass)], shape = 16, size = rel(0.8), alpha = 0.7) +
  geom_point(data = volcXY[(fltr_pass)], shape = 16, size = rel(1)) +
  geom_label_repel(data = volcXY[(mark), ], colour = 'black', min.segment.length = 0, segment.size = 0.3, size = rel(2.5), force = 2, force_pull = 0.1, max.overlaps = 100) +
  scale_colour_manual(values = c('grey50', '#2244FF')) +
  labs(title = params$comparison) +
  theme(legend.position = 'bottom')

p_volcano
```

```{r shrunkvolcano, fig.height=15, fig.width=15}
# p_shrunkvolcano <- ggplot(volcXY, aes(x = shrunkLFC, y = -log10(padj), colour = fltr_pass, label = gene_name)) +
#   geom_point(data = volcXY[(!fltr_pass)], shape = 16, size = rel(0.8), alpha = 0.7) +
#   geom_point(data = volcXY[(fltr_pass)], shape = 16, size = rel(1)) +
#   geom_label_repel(data = volcXY[(mark), ], colour = 'black', min.segment.length = 0, segment.size = 0.3, size = rel(2.5), force = 2, force_pull = 0.1, max.overlaps = 100) +
#   scale_colour_manual(values = c('grey50', '#2244FF')) +
#   labs(title = params$comparison) +
#   theme(legend.position = 'bottom')
# 
# p_shrunkvolcano
```

## FC & abundance

```{r ma, fig.height=30, fig.width=10}
maXY <- unique(DT[mainvar == 'reference' & count_type == 'normalized', .(gene_id, gene_name, count_type, condGeneMean, log2FoldChange, fltr_pass, mark)])

p_ma <- ggplot(maXY, aes(x = condGeneMean, y = log2FoldChange, colour = fltr_pass, label = gene_name)) +
  facet_wrap(~ count_type, scales = 'free', ncol = 1) +
  geom_point(data = maXY[(!fltr_pass)], shape = 16, size = rel(0.8), alpha = 0.7) +
  geom_hline(yintercept = 0, linetype = 'dashed') +
  geom_point(data = maXY[(fltr_pass)], shape = 16, size = rel(1)) +
  geom_label_repel(data = maXY[(mark), ], colour = 'black', min.segment.length = 0, segment.size = 0.3, size = rel(2), force = 2, force_pull = 0.1, max.overlaps = 100) +
  scale_x_log10() +
  scale_colour_manual(values = c('grey50', '#2244FF')) +
  labs(title = params$comparison, x = 'Reference abundance') +
  theme(legend.position = 'bottom')

p_ma
```

## Mean abundances

`fltr_pass` represents genes that meet all of the criteria: FDR < `r params$max_q` , abs(L2FC) > `r params$min_lfc`, mean raw count in at least one condition > `r params$min_count`, and mean TPM in at least one condition > `r params$min_tpm`.

```{r expression, fig.height=30, fig.width=10}
abundXY <- dcast(unique(DT[count_type == 'tpm', .(gene_id, gene_name, count_type, condGeneMean, fltr_abund_pass, fltr_de_pass, fltr_pass, mark, mainvar)]), '... ~ mainvar', value.var = 'condGeneMean')

p_XY <- ggplot(abundXY, aes(x = reference, y = target, label = gene_name, colour = fltr_pass)) +
  facet_wrap(~ count_type, scales='free', ncol = 1) +
  geom_point(data = abundXY[!(fltr_pass), ], shape = 16, size = rel(0.8), alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +
  geom_point(data = abundXY[(fltr_pass), ], shape = 16, size = rel(1)) +
  geom_label_repel(data = abundXY[(mark), ], colour = 'black', min.segment.length = 0, segment.size = 0.3, size = rel(2), force = 2, force_pull = 0.01, max.overlaps = 100) +
  scale_x_log10() +
  scale_y_log10() +
  scale_colour_manual(values = c('grey50', '#2244FF')) +
  labs(title = params$comparison) +
  theme(legend.position = 'bottom')

p_XY
```

## Density distributions

The dotted lines represent the abundance thresholds that will be applied in accepting the DE results: mean raw count in at least one condition > `r params$min_count`, and mean TPM in at least one condition > `r params$min_tpm`.

```{r expresion_density, fig.height=10, fig.width=15}
count_thresh <- data.frame(count_type = factor(c('raw', 'tpm'), levels = c('raw', 'tpm', 'normalised', 'vst'), ordered = TRUE), thresh = c(params$min_count, params$min_tpm))

p_dense <- ((ggplot(DT[count_type != 'vst' & mainvar == 'reference', .(sample, abundance, count_type, mainvar)], 
                    aes(x = abundance, colour = sample)) +
              facet_grid(count_type ~ mainvar, scales = 'free') +
              geom_vline(data = count_thresh, aes(xintercept = thresh), linetype = 'dotted') +
              geom_density() +
              scale_x_log10() +
              labs(title = 'Abundance distribution') +
              theme(legend.position = 'left') ) +
              
            (ggplot(DT[count_type != 'vst' & mainvar == 'target', .(sample, abundance, count_type, mainvar)], 
                    aes(x = abundance, colour = sample)) +
              facet_grid(count_type ~ mainvar, scales = 'free') +
              geom_vline(data = count_thresh, aes(xintercept = thresh), linetype = 'dotted') +
              geom_density() +
              scale_x_log10() +
              labs(title = 'Abundance distribution') +
              theme(legend.position = 'right') )) /

            ((ggplot(DT[count_type == 'vst' & mainvar == 'reference', .(sample, abundance, count_type, mainvar)], 
                     aes(x = abundance, colour = sample)) +
                facet_grid(count_type ~ mainvar, scales = 'free', switch = 'x') +
                geom_density() +
                theme(legend.position = 'none') ) |
               
            (ggplot(DT[count_type == 'vst' & mainvar == 'target', .(sample, abundance, count_type, mainvar)], 
                    aes(x = abundance, colour = sample)) +
                facet_grid(count_type ~ mainvar, scales = 'free', switch = 'x') +
                geom_density() +
                theme(legend.position = 'none') )) +

            plot_layout(heights = c(3, 1))

p_dense
```


## Selected gene abundances

### Heatmap

The genes are ordered by decreasing fold-change and the samples are grouped by condition.

```{r heatmap, fig.height=40, fig.width=15}
heatXY <- DT[(mark) & count %in% c('tpm', 'vst'), .(gene_id, gene_name, sample, abundance, condGeneMean, count_type, mainvar, log2FoldChange)]
setorder(heatXY, mainvar, log2FoldChange)
heatXY[, sample := factor(sample, levels = unique(sample), ordered = TRUE)]
heatXY[, gene_name := factor(gene_name, levels = unique(gene_name), ordered = TRUE)]

p_heat <- (ggplot(heatXY[count_type == 'tpm', ], aes(x = sample, y = gene_name, fill = log10(abundance))) +
            facet_wrap(~ count_type, scales = 'free') +
            geom_tile() +
            scale_fill_gradient(low = 'black', high = 'yellow') +
            theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) ) +

            (ggplot(heatXY[count_type == 'vst', ], aes(x = sample, y = gene_name, fill = abundance)) +
            facet_wrap(~ count_type, scales = 'free') +
            geom_tile() +
            scale_fill_gradient(low = 'black', high = 'yellow') +
            theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) ) +
    plot_layout(ncol = 1)

p_heat
```

### Detail

The genes are ordered by decreasing fold-change.

The dotted lines represent the abundance criteria: mean raw count in at least one condition > `r params$min_count`, and mean TPM in at least one condition > `r params$min_tpm`.

```{r details, fig.height=20, fig.width=15}
cntthresh <- data.frame(count_type = factor(c('raw', 'tpm'), ordered = TRUE, levels = c('raw', 'tpm', 'normalised', 'vst')), abundance = c(params$min_count, params$min_tpm))

p_box <- ggplot(heatXY[count_type != 'normalised', ], aes(y = gene_name, x = abundance, colour = mainvar)) +
  facet_wrap(~ count_type, nrow = 1, scales = 'free_x') +
  geom_vline(data = cntthresh, aes(xintercept = abundance), linetype = 'dotted') +
  geom_jitter(shape = 16, size = rel(1), height = 0.2) +
  geom_boxplot(fill = 'transparent', outlier.alpha = 0, width = 0.5, linewidth = 0.2) +
  # scale_x_continuous(trans = 'log2') +
  # scale_x_continuous(trans = 'sqrt') +
  scale_x_log10() +
  scale_colour_manual(values = c('blue', 'red')) + 
  labs(title = params$comparison) +
  theme(legend.position = 'bottom', panel.grid.minor.x = element_blank())

p_box
```


# GSEA

```{r gsea}
```


# Session

```{r session}
sessionInfo()
```

