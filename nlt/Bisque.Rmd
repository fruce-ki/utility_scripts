---
title: "Deconvolution - Bisque"
author: "Kimon Froussios"
date: "2023-09-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(Biobase)
library(BisqueRNA)

setwd("~/Camilla/DECONVOLUTION/")
```

# Input

```{r input_nlt}
bulk_mtx1 <- fread("~/Camilla/Neurolentech/counting_summary_batch1/summary_unique.tsv")
bulk_mtx2 <- fread("~/Camilla/Neurolentech/counting_summary_batch2/summary_unique.tsv")
bulk_mtx3 <- fread("~/Camilla/Neurolentech/counting_summary_batch3/summary_unique.tsv")
bulk_meta <- fread("~/Camilla/Neurolentech/SampleInfo_Batch_1,2,3.txt")

# Tidy up
bulk_meta[Timepoint == '6W', Timepoint := 'W6']
bulk_meta[, colnum := 1:.N, by= sBatch]
bulk_meta[, newSample := paste(sBatch, Batch, Sex, Timepoint, Type, Construct, colnum, sep='_')]
bulk_mtx <- Reduce(function(x,y){ merge(x, y, all=TRUE, by=c("gene_id", "gene")) },
                   list(bulk_mtx1, bulk_mtx2, bulk_mtx3) )
setnames(bulk_mtx, c("gene_id", "gene", bulk_meta$newSample))
bulk_genes <- bulk_mtx$gene
bulk_ensembl <- bulk_mtx$gene_id
bulk_symbols <- bulk_mtx$gene
bulk_mtx <- as.matrix(bulk_mtx[, 3:ncol(bulk_mtx)])
rownames(bulk_mtx) <- bulk_genes

rm("bulk_mtx1", "bulk_mtx2", "bulk_mtx3")
```

```{r input_sc}
sc_mtx <- fread("~/Camilla/SC_Atlas/exprMatrix.tsv")
cell_meta <- fread("~/Camilla/SC_Atlas/meta.tsv")

# Tidy up
cells <- colnames(sc_mtx)
sc_genes <- sc_mtx$gene
sc_mtx <- as.matrix(sc_mtx[, 2:ncol(sc_mtx), with=FALSE])
```

```{r input_sanity}
cat("# of genes in SC:", length(sc_genes), "unique:", length(unique(sc_genes)), "\n" )
cat("# of genes in bulk:", length(bulk_genes), "unique:", length(unique(bulk_genes)), "\n")
cat("# of IDs in bulk:", length(bulk_ensembl), "unique:", length(unique(bulk_ensembl)), "\n")
# So, different IDs, same names.
bulk_duplicates <- bulk_genes[duplicated(bulk_genes)]

cat("All detected SC genes are in the bulk annotation?", all(sc_genes %in% bulk_genes), "\n")
cat("How many are not?", sum(! sc_genes %in% bulk_genes), "\n")

cat("Any SC genes among the bulk duplicated ones?", sum(sc_genes %in% bulk_duplicates), "\n")
```

According to the Single Cell Atlas paper, the expression is annotated with GRCh38-0.1.2. Unfortunately, 0.1.2 does not match the versioning system of either NCBI nor Ensembl. In the entirety of Pubmed and the other NCBI databases, this is the only paper that references this version. Without knowing the sub-version of GRCh38 it represents, I cannot cross-reference the genes and investigate what is going on with the gene symbols that do not have a match in the bulk dataset. So these genes will need to be ignored.

The duplicate gene symbols also have to be completely removed, as the SCAtlas uses symbols as its gene identifiers.

```{r input_convert}
# Remove duplicated and unmatched genes
join_genes <- intersect(bulk_genes[! bulk_genes %in% bulk_duplicates], sc_genes)
cat("Working with", length(join_genes), "genes\n")

sc_mtx <- sc_mtx[rownames(sc_mtx) %in% join_genes]
```