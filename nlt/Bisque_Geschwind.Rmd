---
title: "Deconvolution - Bisque & Geschwind"
author: "Kimon Froussios"
date: "2023-09-21"
output:
	html_document:
	code_folding: hide
	toc: true
	toc_float: true
	toc_depth: 3
	collapsed: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(biomaRt)
library(AnnotationHub)
require(ensembldb)
library(Biobase)
library(BisqueRNA)

setwd("I:/Camilla/DECONVOLUTION")
```

# Input

```{r input_nlt}
# Annotated with Ensembl 94
bulk_mtx1 <- fread("I:/Camilla/Neurolentech/counting_summary_batch1/summary_unique.tsv")
bulk_mtx2 <- fread("I:/Camilla/Neurolentech/counting_summary_batch2/summary_unique.tsv")
bulk_mtx3 <- fread("I:/Camilla/Neurolentech/counting_summary_batch3/summary_unique.tsv")
bulk_meta <- fread("I:/Camilla/Neurolentech/SampleInfo_Batch_1,2,3.txt")

# Tidy up
bulk_meta[Timepoint == '6W', Timepoint := 'W6']
bulk_meta[, colnum := 1:.N, by= sBatch]
bulk_meta[, newSample := paste(sBatch, Batch, Sex, Timepoint, Type, Construct, colnum, sep='_')]
bulk_mtx <- Reduce(function(x,y){ merge(x, y, all=TRUE, by=c("gene_id", "gene")) },
                   list(bulk_mtx1, bulk_mtx2, bulk_mtx3) )
setnames(bulk_mtx, c("gene_id", "gene", bulk_meta$newSample))
bulk_genes <- bulk_mtx[, .(gene_id, gene)]
bulk_mtx <- as.matrix(bulk_mtx[, 3:ncol(bulk_mtx), with=FALSE])
rownames(bulk_mtx) <- bulk_genes$gene_id

rm("bulk_mtx1", "bulk_mtx2", "bulk_mtx3")

cat("# of genes in bulk:", length(bulk_genes$gene), "unique:", length(unique(bulk_genes$gene)), "\n")
cat("# of IDs in bulk:", length(bulk_genes$gene_id), "unique:", length(unique(bulk_genes$gene_id)), "\n")
# So, different IDs, same names.
bulk_duplicates <- bulk_genes[duplicated(gene), .(gene, gene_id)]
```

There are duplicated gene symbols in the bulk data, but they have unique Ensembl IDs. Not sure what to think of that, but the SC data only provides gene symbols, and a one-to-many relationship is a problem for matching up data between the datasets.

```{r input_sc}
# Annotated with Ensembl 87
load("I:/Camilla/SC_geschwind/raw_counts_mat.rdata") # raw_counts_mat
cell_mtx <- as.matrix(raw_counts_mat)
cell_meta <- fread("I:/Camilla/SC_geschwind/cell_metadata.csv")
rm("raw_counts_mat")

cells <- colnames(cell_mtx)
cell_genes <- rownames(cell_mtx)

# From symbols to IDs
# Way #1
mart <- useEnsembl("ensembl", "hsapiens_gene_ensembl")
# listAttributes(mart)
# listFilters(mart)
generef1 <- getBM(attributes = c("ensembl_gene_id", "external_gene_name"),
								 filters = "external_gene_name",
								 values = cell_genes,
								 mart = mart)
cat("Collecting name-ID info from current mart. Found", nrow(generef1), "genes\n")
names(generef1) <- c("GENEID", "GENENAME")
cat("Mart info contains duplicate IDs with conflicting names:", sum(duplicated(generef1$GENEID)), "\n")
cat("Mart info contains duplicate names with conflicting IDs:", sum(duplicated(generef1$GENENAME)), "\n")

# Way #2
hub <- AnnotationHub()
query(hub, c("homo sapiens","ensdb"))
ensdb <- hub[["AH53211"]]  # Ensembl 87, as per data documentation
generef2 <- select(ensdb, cell_genes, "GENEID", "GENENAME")
cat("Collecting name-ID info from archived database. Found", nrow(generef2), "genes\n")
cat("DB info contains duplicate IDs with conflicting names:", sum(duplicated(generef2$GENEID)), "\n")
cat("DB info contains duplicate names with conflicting IDs:", sum(duplicated(generef2$GENENAME)), "\n")

ref <- unique(as.data.table(rbind(generef1[, c("GENENAME", "GENEID")], generef2[, c("GENENAME", "GENEID")])))
cat("Combined info:", nrow(ref), "genes\n")
cat("Combined info contains duplicate IDs with conflicting names:", sum(duplicated(ref$GENEID)), "\n")
cat("Combined info contains duplicate names with conflicting IDs:", sum(duplicated(ref$GENENAME)), "\n")
ref_duplicates <- unique(ref[duplicated(GENENAME), GENENAME])
cat("Unique duplicates:", length(ref_duplicates), "\n")

# The duplicates problem persists, so these are of no help
rm(ref_duplicates, generef1, generef2, ensdb, hub, mart)

# Why don't the samples match up?
cat("Cells in the expression matrix that are not in the metadata:", sum(! cells %in% cell_meta$Cell), "\n")
aaa_cells <- cells[which(! cells %in% cell_meta$Cell)]
cat(aaa_cells, "\n")
cat("Are they a duplicated column?\n")
print(summary(cell_mtx[, aaa_cells]))

cat("Cells in the metadata that are not in the matrix:", sum(! cell_meta$Cell %in% cells), "\n")

# Clean up
cell_mtx <- cell_mtx[, cell_meta$Cell] # As by-product, ensure the order matches
cells <- colnames(cell_mtx)
```

There are 10 samples in the reference SC data that are not present in the metadata. Without metadata, they are not useful for this analysis and shall be removed.

The database references, that I wanted to use to resolve gene names bypassing the ambiguous mappings in the bulk data, also have the problem of multiple IDs mapped to the same symbol. This means that the affected genes cannot be matched unambiguously between the datasets and must be removed. Hopefully they are not critical for this analysis...

```{r input_sanity}
cat("# of genes in SC:", length(cell_genes), "unique:", length(unique(cell_genes)), "\n" )
cat("SC genes that match in the bulk gene symbols", sum(cell_genes %in% bulk_genes$gene), "\n")
cat("SC genes that match in the bulk gene IDs", sum(cell_genes %in% bulk_genes$gene_id), "\n")
cat("SC genes that are in the duplicated bulk gene symbols", sum(cell_genes %in% bulk_duplicates$gene)) 

# Match genes across datasets and convert SC to Ensembl

bulk_genes <- bulk_genes[! gene %in% bulk_duplicates$gene, ]
setkey(bulk_genes, gene)

convertid <- data.table(from = unique(cell_genes), to = unique(cell_genes), byname = FALSE, byid = FALSE)
stopifnot(all(convertid$from == convertid$to))
convertid[from %in% bulk_genes$gene, byname := TRUE]
convertid[(byname), to := bulk_genes[from, gene_id]]
convertid[from %in% bulk_genes$gene_id, byid := TRUE]
cat("SC ID conversion:", sum(convertid$byname),"from symbol,", sum(convertid$byid), "already as ID,", sum(! (convertid$byname | convertid$byid)), "unmatched\n")

convertid <- convertid[convertid$byname | convertid$byid, ] # only genes that matched
cat("Are there still duplicates? symbols", sum(duplicated(convertid$from)), "IDs", sum(duplicated(convertid$to)))
convertid <- convertid[! to %in% convertid[duplicated(convertid$to), to], ]
cat("Number of genes matched", nrow(convertid), "\n")
setkey(convertid, from)

# apply the ids to the SC matrix
cell_mtx <- cell_mtx[rownames(cell_mtx) %in% convertid$from, ] # matched genes
rownames(cell_mtx) <- convertid[rownames(cell_mtx), to]
```

The analysis will proceed with the intersection of genes between the datasets.

```{r filter}
bulk_mtx <- bulk_mtx[convertid$to, ]
cell_mtx <- cell_mtx[convertid$to, ]
```


```{r input_convert}
# Convert to ExpressionSet for Bisque

bulk_exset <- Biobase::ExpressionSet(assayData = bulk_mtx)
#rm(bulk_mtx)

sc_pdata <- new("AnnotatedDataFrame",
                data = data.frame(check.names=FALSE, check.rows=FALSE, stringsAsFactors=FALSE,
                									row.names = cell_meta$Cell,
                									SubjectName = cell_meta$Donor,
                									cellType = cell_meta$Cluster),
                varMetadata = data.frame(labelDescription=c("SubjectName", "cellType"),
                											 row.names=c("SubjectName", "cellType")) )

cell_exset <- Biobase::ExpressionSet(assayData = cell_mtx[convertid$to, ], phenoData = sc_pdata)
#rm(sc.pdata, bulk_mtx)
```

# Reference-based decomposition

```{r decomposition}
res <- BisqueRNA::ReferenceBasedDecomposition(bulk_exset, cell_exset, 
																							markers = NULL, # use all available genes
																							use.overlap = FALSE) # no shared samples between bulk & SC
```

```{r results}
compositions <- res$bulk.props

### Rounding to any precision
mround <- function(x, base){
  base*round(x/base, digits = 0)
}

fwrite(as.data.frame(mround(t(compositions), 0.0001)), 
			 file = "I:/Camilla/DECONVOLUTION/Bisque_Geschwind_compositions.tsv", quote = FALSE, sep = "\t")

knitr::kable(t(compositions), digits = 4)
```